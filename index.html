<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Météo Amiens - Temps réel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            line-height: 1.4;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border: double 3px #00ff00;
            padding: 15px;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 12px;
            color: #ffff00;
        }

        .timestamp {
            color: #888;
            margin-top: 10px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .panel {
            border: solid 1px #00ff00;
            padding: 20px;
            background: rgba(0, 255, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .data-line {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .label {
            color: #ccc;
        }

        .value {
            color: #00ff00;
            font-weight: bold;
        }

        .value.warning {
            color: #ffff00;
        }

        .value.danger {
            color: #ff0000;
        }

        .weather-visual {
            margin: 30px 0;
            border: double 3px #00ff00;
            padding: 20px;
            text-align: center;
        }

        .visual-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .weather-icon {
            font-size: 4em;
            line-height: 1.2;
            margin: 20px auto;
            text-align: center;
        }

        .weather-description {
            color: #ffff00;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
        }

        .alerts-section {
            margin: 20px 0;
            border: solid 2px #ff0000;
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
        }

        .alert-title {
            color: #ff0000;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .alerts-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .alert-item {
            color: #ffff00;
            padding: 5px;
            border-left: 3px solid #ff0000;
            padding-left: 10px;
        }

        .sun-info {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #333;
            background: rgba(255, 255, 0, 0.05);
        }

        .sun-item {
            text-align: center;
        }

        .sun-label {
            color: #888;
            font-size: 12px;
        }

        .sun-value {
            color: #ffff00;
            font-weight: bold;
            font-size: 16px;
        }

        .forecast-section {
            margin: 30px 0;
            padding: 20px;
            border: double 3px #00ff00;
            background: rgba(0, 255, 0, 0.02);
        }

        .forecast-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }

        .forecast-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            font-family: 'Roboto Mono', 'Courier New', monospace;
            color: #00ff00;
        }

        .forecast-day {
            border: 1px solid #333;
            padding: 15px 5px;
            text-align: center;
            background: rgba(0, 255, 0, 0.01);
        }

        .forecast-day.today {
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.05);
        }

        .forecast-day-name {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .forecast-icon {
            font-size: 32px;
            margin: 10px 0;
            line-height: 1;
        }

        .forecast-temps {
            margin: 10px 0;
            font-size: 14px;
        }

        .temp-max {
            color: #ff6666;
            font-weight: bold;
        }

        .temp-min {
            color: #6666ff;
        }

        .forecast-rain {
            color: #00ffff;
            font-size: 12px;
            margin-top: 5px;
        }

        .forecast-summary {
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #333;
            text-align: center;
            color: #ffff00;
        }

        .hourly-forecast {
            margin: 30px 0;
            padding: 20px;
            border: double 3px #00ff00;
            background: rgba(0, 255, 0, 0.02);
        }

        .hourly-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }

        .hourly-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .hourly-item {
            border: 1px solid #333;
            padding: 15px 10px;
            text-align: center;
            background: rgba(0, 255, 0, 0.01);
        }

        .hourly-item.current {
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.05);
        }

        .hourly-period {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .hourly-time {
            color: #888;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .hourly-icon {
            font-size: 28px;
            margin: 10px 0;
            line-height: 1;
        }

        .hourly-temp {
            color: #00ff00;
            font-weight: bold;
            font-size: 16px;
            margin: 5px 0;
        }

        .hourly-rain {
            color: #00ffff;
            font-size: 12px;
            margin-top: 5px;
        }

        .hourly-wind {
            color: #888;
            font-size: 11px;
            margin-top: 3px;
        }

        @media (max-width: 900px) {
            .forecast-container {
                grid-template-columns: repeat(4, 1fr);
            }
            .hourly-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .forecast-container {
                grid-template-columns: repeat(2, 1fr);
            }
            .hourly-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .activity-section {
            margin: 30px 0;
            border: solid 1px #888;
            padding: 20px;
        }

        .activity-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #333;
            background: rgba(0, 255, 0, 0.02);
        }

        .status-ok { color: #00ff00; }
        .status-caution { color: #ffff00; }
        .status-bad { color: #ff0000; }

        .footer {
            margin-top: 40px;
            text-align: center;
            color: #666;
            border-top: 1px solid #333;
            padding-top: 20px;
        }

        .ascii-art {
            color: #888;
            font-size: 10px;
            text-align: center;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre;
            line-height: 1.2;
        }

        .loading {
            color: #ffff00;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            body {
                font-size: 12px;
                padding: 10px;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .activity-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">═══ METEO AMIENS ═══</div>
            <div class="subtitle">Données en temps réel</div>
            <div class="timestamp" id="timestamp">DERNIERE MAJ: --</div>
            <button onclick="loadWeatherData(true)" style="background: transparent; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; margin-top: 10px; cursor: pointer; font-family: inherit; font-size: 11px;">↻ RAFRAICHIR</button>
        </div>

        <div class="loading" id="loading">
            CHARGEMENT DES DONNEES SATELLITAIRES...
            [████████████████████████████████████████] 100%
        </div>

        <div id="weather-content" style="display: none;">
            <div class="weather-visual">
                <div class="visual-title">[ CONDITIONS ACTUELLES ]</div>
                <div class="weather-icon" id="weather-icon">
                    <!-- Emoji météo sera inséré ici par JavaScript -->
                </div>
                <div class="weather-description" id="weather-description">
                    <!-- Description sera insérée ici -->
                </div>
                <div class="sun-info">
                    <div class="sun-item">
                        <div class="sun-label">LEVER</div>
                        <div class="sun-value" id="sunrise">--:--</div>
                    </div>
                    <div class="sun-item">
                        <div class="sun-label">COUCHER</div>
                        <div class="sun-value" id="sunset">--:--</div>
                    </div>
                    <div class="sun-item">
                        <div class="sun-label">LUMIERE RESTANTE</div>
                        <div class="sun-value" id="daylight-remaining">--h--</div>
                    </div>
                </div>
            </div>

            <div class="hourly-forecast">
                <div class="hourly-title">[ PREVISIONS PROCHAINES HEURES ]</div>
                <div class="hourly-container" id="hourly-container">
                    <!-- Prévisions horaires seront insérées ici -->
                </div>
            </div>

            <div class="alerts-section" id="alerts-section" style="display: none;">
                <div class="alert-title">[ ALERTES ]</div>
                <div class="alerts-grid" id="alerts-grid">
                    <!-- Alertes dynamiques -->
                </div>
            </div>

            <div class="main-grid">
                <div class="panel">
                    <div class="panel-title">[ TEMPERATURE ]</div>
                    <div class="data-line">
                        <span class="label">ACTUELLE:</span>
                        <span class="value" id="temp-current">--°C</span>
                    </div>
                    <div class="data-line">
                        <span class="label">RESSENTIE:</span>
                        <span class="value" id="temp-feels">--°C</span>
                    </div>
                    <div class="data-line">
                        <span class="label">MIN/MAX:</span>
                        <span class="value" id="temp-minmax">--°C / --°C</span>
                    </div>
                    <div class="data-line">
                        <span class="label">TENDANCE 3H:</span>
                        <span class="value" id="temp-trend">STABLE</span>
                    </div>
                    <div class="data-line">
                        <span class="label">NORMAL SAISON:</span>
                        <span class="value" id="temp-normal">OUI</span>
                    </div>
                    <div class="data-line">
                        <span class="label">INDICE UV:</span>
                        <span class="value" id="uv-index">--</span>
                    </div>
                    <div class="data-line">
                        <span class="label">CREME SOLAIRE:</span>
                        <span class="value" id="sunscreen">NON</span>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">[ PRECIPITATIONS ]</div>
                    <div class="data-line">
                        <span class="label">PROBABILITE:</span>
                        <span class="value" id="rain-prob">--%</span>
                    </div>
                    <div class="data-line">
                        <span class="label">QUANTITE SI PLUIE:</span>
                        <span class="value" id="rain-amount">-- mm</span>
                    </div>
                    <div class="data-line">
                        <span class="label">DERNIERE PLUIE:</span>
                        <span class="value" id="last-rain">-- JOURS</span>
                    </div>
                    <div class="data-line">
                        <span class="label">CUMUL SEMAINE:</span>
                        <span class="value" id="week-rain">-- mm</span>
                    </div>
                    <div class="data-line">
                        <span class="label">PARAPLUIE REQUIS:</span>
                        <span class="value" id="umbrella-needed">NON</span>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">[ VENT & VISIBILITE ]</div>
                    <div class="data-line">
                        <span class="label">VITESSE MOYENNE:</span>
                        <span class="value" id="wind-speed">-- km/h</span>
                    </div>
                    <div class="data-line">
                        <span class="label">RAFALES MAX:</span>
                        <span class="value" id="wind-gusts">-- km/h</span>
                    </div>
                    <div class="data-line">
                        <span class="label">DIRECTION:</span>
                        <span class="value" id="wind-direction">--</span>
                    </div>
                    <div class="data-line">
                        <span class="label">CLASSIFICATION:</span>
                        <span class="value" id="wind-class">BRISE LEGERE</span>
                    </div>
                    <div class="data-line">
                        <span class="label">DANGEREUX:</span>
                        <span class="value" id="wind-danger">NON</span>
                    </div>
                    <div class="data-line">
                        <span class="label">VISIBILITE:</span>
                        <span class="value" id="visibility">-- km</span>
                    </div>
                    <div class="data-line">
                        <span class="label">PHARES REQUIS:</span>
                        <span class="value" id="headlights">NON</span>
                    </div>
                </div>
            </div>

            <div class="forecast-section">
                <div class="forecast-title">[ PREVISIONS 7 JOURS ]</div>
                <div class="forecast-container" id="forecast-container">
                    <!-- Prévisions 7 jours seront insérées ici -->
                </div>
                <div class="forecast-summary" id="forecast-summary">
                    <!-- Résumé des prévisions -->
                </div>
            </div>

            <div class="activity-section">
                <div class="activity-title">[ ACTIVITES CONSEILLEES ]</div>
                <div class="activity-grid">
                    <div class="activity-item">
                        <span>VELO/FOOTING:</span>
                        <span class="status-ok" id="activity-sport">PARFAIT</span>
                    </div>
                    <div class="activity-item">
                        <span>PIQUE-NIQUE:</span>
                        <span class="status-caution" id="activity-picnic">PREVOIR PULL</span>
                    </div>
                    <div class="activity-item">
                        <span>JARDINAGE:</span>
                        <span class="status-ok" id="activity-garden">IDEAL</span>
                    </div>
                    <div class="activity-item">
                        <span>ETENDRE LINGE:</span>
                        <span class="status-ok" id="activity-laundry">SECHERA EN 3H</span>
                    </div>
                    <div class="activity-item">
                        <span>BARBECUE:</span>
                        <span class="status-ok" id="activity-bbq">GO</span>
                    </div>
                    <div class="activity-item">
                        <span>LAVER VOITURE:</span>
                        <span class="status-caution" id="activity-car">ATTENDRE 2J</span>
                    </div>
                    <div class="activity-item">
                        <span>AERER MAISON:</span>
                        <span class="status-ok" id="activity-ventilate">OUI</span>
                    </div>
                    <div class="activity-item">
                        <span>ARROSER JARDIN:</span>
                        <span class="status-caution" id="activity-watering">NON</span>
                    </div>
                    <div class="activity-item">
                        <span>SECHER LINGE DEHORS:</span>
                        <span class="status-ok" id="activity-drying">PARFAIT</span>
                    </div>
                </div>
            </div>

            <div class="ascii-art">┌─────────────────────────────────────────────────────────────┐
│               Météo locale sans exagération                │
│               Données Open-Meteo.com fiables               │
└─────────────────────────────────────────────────────────────┘</div>
        </div>

        <div class="footer">
            <div>Station Amiens - Coordonnées: 49.9°N, 2.3°E</div>
            <div>Source: Open-Meteo.com | Mise à jour: 10 minutes</div>
        </div>
    </div>

    <script>
        // Coordonnées d'Amiens
        const AMIENS_LAT = 49.9;
        const AMIENS_LON = 2.3;


        // Classification des vents selon échelle de Beaufort
        function getWindClassification(speed) {
            if (speed < 6) return "CALME";
            if (speed < 12) return "BRISE LEGERE";
            if (speed < 20) return "BRISE MODEREE";
            if (speed < 29) return "BONNE BRISE";
            if (speed < 39) return "VENT FRAIS";
            if (speed < 50) return "VENT FORT";
            return "TEMPETE";
        }

        // Direction du vent en texte
        function getWindDirection(degrees) {
            const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSO", "SO", "OSO", "O", "ONO", "NO", "NNO"];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        // Déterminer l'emoji et la description selon le code météo
        function getWeatherVisualization(weatherCode, isDay, precipitation, cloudCover, windSpeed) {
            let emoji = "";
            let description = "";

            // Codes météo WMO
            // 0: Clear sky
            // 1, 2, 3: Mainly clear, partly cloudy, and overcast
            // 45, 48: Fog and depositing rime fog
            // 51, 53, 55: Drizzle: Light, moderate, and dense intensity
            // 61, 63, 65: Rain: Slight, moderate and heavy intensity
            // 71, 73, 75: Snow fall: Slight, moderate, and heavy intensity
            // 80, 81, 82: Rain showers: Slight, moderate, and violent
            // 95: Thunderstorm: Slight or moderate
            // 96, 99: Thunderstorm with slight and heavy hail

            if (!isDay) {
                emoji = "🌙";
                description = "NUIT ";
            }

            switch(weatherCode) {
                case 0:
                    if (isDay) {
                        emoji = "☀️";
                        description = "ENSOLEILLE";
                    } else {
                        description += "CLAIRE";
                    }
                    break;
                case 1:
                case 2:
                    if (isDay) {
                        emoji = "🌤️";
                        description = "PARTIELLEMENT NUAGEUX";
                    } else {
                        description += "PARTIELLEMENT NUAGEUSE";
                    }
                    break;
                case 3:
                    emoji = "☁️";
                    description = isDay ? "NUAGEUX" : description + "NUAGEUSE";
                    break;
                case 45:
                case 48:
                    emoji = "🌫️";
                    description = "BROUILLARD";
                    break;
                case 51:
                case 53:
                case 55:
                    emoji = "🌦️";
                    description = "BRUINE";
                    break;
                case 61:
                case 63:
                case 65:
                    emoji = "🌧️";
                    description = weatherCode === 65 ? "FORTE PLUIE" : "PLUIE";
                    break;
                case 71:
                case 73:
                case 75:
                    emoji = "🌨️";
                    description = "NEIGE";
                    break;
                case 80:
                case 81:
                case 82:
                    emoji = "🌦️";
                    description = "AVERSES";
                    break;
                case 95:
                case 96:
                case 99:
                    emoji = "⛈️";
                    description = "ORAGE";
                    break;
                default:
                    // Fallback basé sur d'autres paramètres
                    if (precipitation > 0.5) {
                        emoji = "🌧️";
                        description = "PLUVIEUX";
                    } else if (cloudCover > 70) {
                        emoji = "☁️";
                        description = "TRES NUAGEUX";
                    } else if (cloudCover > 30) {
                        emoji = "⛅";
                        description = "PARTIELLEMENT NUAGEUX";
                    } else if (windSpeed > 30) {
                        emoji = "💨";
                        description = "VENTEUX";
                    } else {
                        emoji = isDay ? "☀️" : "🌙";
                        description = isDay ? "CLAIR" : "NUIT CLAIRE";
                    }
            }

            return { emoji, description };
        }

        // Afficher les alertes météo
        function displayAlerts(data) {
            const alerts = [];
            const current = data.current;
            const daily = data.daily;

            // Alerte gel
            if (daily.temperature_2m_min[0] <= 0) {
                alerts.push(`⚠️ GEL NOCTURNE: ${daily.temperature_2m_min[0].toFixed(1)}°C - Protéger plantes et pare-brise`);
            }

            // Alerte canicule
            if (daily.temperature_2m_max[0] >= 35) {
                alerts.push(`⚠️ FORTE CHALEUR: ${daily.temperature_2m_max[0].toFixed(1)}°C - Hydratation importante`);
            }

            // Alerte tempête
            if (current.wind_gusts_10m > 70) {
                alerts.push(`⚠️ RAFALES VIOLENTES: ${Math.round(current.wind_gusts_10m)} km/h - Éviter déplacements`);
            }

            // Alerte visibilité
            if (current.visibility && current.visibility < 200) {
                alerts.push(`⚠️ BROUILLARD DENSE: Visibilité ${current.visibility}m - Conduite dangereuse`);
            }

            // Alerte UV
            if (current.uv_index && current.uv_index > 7) {
                alerts.push(`⚠️ UV EXTREMES: Indice ${current.uv_index.toFixed(1)} - Protection maximale requise`);
            }

            const alertsSection = document.getElementById('alerts-section');
            const alertsGrid = document.getElementById('alerts-grid');

            if (alerts.length > 0) {
                alertsSection.style.display = 'block';
                alertsGrid.innerHTML = alerts.map(alert => `<div class="alert-item">${alert}</div>`).join('');
            } else {
                alertsSection.style.display = 'none';
            }
        }

        // Fonction pour déterminer les périodes de la journée
        function getHourlyPeriods(hourlyData) {
            const now = new Date();
            const currentHour = now.getHours();
            const periods = [];

            // Déterminer les heures cibles selon l'heure actuelle
            const targetHours = [];

            // Ajouter "Maintenant"
            targetHours.push({
                hour: currentHour,
                label: "MAINTENANT",
                isCurrent: true
            });

            // Déterminer les prochaines périodes pertinentes
            if (currentHour < 12) {
                targetHours.push({ hour: 12, label: "MIDI" });
                targetHours.push({ hour: 15, label: "APRES-MIDI" });
                targetHours.push({ hour: 19, label: "SOIREE" });
                targetHours.push({ hour: 23, label: "NUIT" });
            } else if (currentHour < 15) {
                targetHours.push({ hour: 15, label: "APRES-MIDI" });
                targetHours.push({ hour: 19, label: "SOIREE" });
                targetHours.push({ hour: 23, label: "NUIT" });
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
            } else if (currentHour < 19) {
                targetHours.push({ hour: 19, label: "SOIREE" });
                targetHours.push({ hour: 23, label: "NUIT" });
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
                targetHours.push({ hour: 12, label: "DEMAIN MIDI", nextDay: true });
            } else if (currentHour < 23) {
                targetHours.push({ hour: 23, label: "NUIT" });
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
                targetHours.push({ hour: 12, label: "DEMAIN MIDI", nextDay: true });
                targetHours.push({ hour: 15, label: "DEMAIN APM", nextDay: true });
            } else {
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
                targetHours.push({ hour: 12, label: "DEMAIN MIDI", nextDay: true });
                targetHours.push({ hour: 15, label: "DEMAIN APM", nextDay: true });
                targetHours.push({ hour: 19, label: "DEMAIN SOIR", nextDay: true });
            }

            // Limiter à 5 périodes maximum
            return targetHours.slice(0, 5);
        }

        // Fonction pour obtenir l'emoji météo horaire
        function getHourlyWeatherEmoji(weatherCode, isDay) {
            const emojiIcons = {
                0: isDay ? "☀️" : "🌙",
                1: isDay ? "🌤️" : "🌙",
                2: isDay ? "⛅" : "☁️",
                3: "☁️",
                45: "🌫️",
                48: "🌫️",
                51: "🌦️",
                53: "🌦️",
                55: "🌦️",
                61: "🌧️",
                63: "🌧️",
                65: "🌧️",
                71: "🌨️",
                73: "🌨️",
                75: "🌨️",
                80: "🌦️",
                81: "🌦️",
                82: "🌦️",
                95: "⛈️",
                96: "⛈️",
                99: "⛈️"
            };
            return emojiIcons[weatherCode] || "❓";
        }

        // Afficher les prévisions horaires
        function displayHourlyForecast(hourlyData) {
            if (!hourlyData || !hourlyData.time) return;

            const periods = getHourlyPeriods(hourlyData);
            const now = new Date();
            let hourlyHTML = "";

            periods.forEach(period => {
                // Calculer l'index dans les données horaires
                let targetDate = new Date();
                if (period.nextDay) {
                    targetDate.setDate(targetDate.getDate() + 1);
                }
                targetDate.setHours(period.hour, 0, 0, 0);

                // Trouver l'index correspondant dans les données
                const targetTimeString = targetDate.toISOString().slice(0, 13) + ":00";
                const dataIndex = hourlyData.time.findIndex(t => t === targetTimeString);

                if (dataIndex === -1) return;

                const temp = Math.round(hourlyData.temperature_2m[dataIndex]);
                const rainProb = hourlyData.precipitation_probability[dataIndex] || 0;
                const rainAmount = hourlyData.precipitation[dataIndex] || 0;
                const windSpeed = Math.round(hourlyData.wind_speed_10m[dataIndex]);
                const weatherCode = hourlyData.weather_code ? hourlyData.weather_code[dataIndex] : 0;
                const isDay = hourlyData.is_day ? hourlyData.is_day[dataIndex] === 1 : (period.hour >= 7 && period.hour <= 20);

                // Format de l'heure
                const timeStr = period.hour.toString().padStart(2, '0') + ':00';

                hourlyHTML += `
                    <div class="hourly-item ${period.isCurrent ? 'current' : ''}">
                        <div class="hourly-period">${period.label}</div>
                        <div class="hourly-time">${timeStr}</div>
                        <div class="hourly-icon">${getHourlyWeatherEmoji(weatherCode, isDay)}</div>
                        <div class="hourly-temp">${temp}°</div>
                        ${rainProb > 0 ? `<div class="hourly-rain">☂ ${rainProb}%</div>` : '<div class="hourly-rain">&nbsp;</div>'}
                        <div class="hourly-wind">💨 ${windSpeed} km/h</div>
                    </div>
                `;
            });

            document.getElementById('hourly-container').innerHTML = hourlyHTML;
        }

        // Afficher prévisions 7 jours
        function displayWeeklyForecast(daily) {
            const days = 7;
            const dayNames = ['DIM', 'LUN', 'MAR', 'MER', 'JEU', 'VEN', 'SAM'];
            const dayNamesFull = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

            // Fonction intelligente pour obtenir l'icône météo selon plusieurs critères
            function getWeatherEmoji(weatherCode, rainProb, maxTemp) {
                // D'abord vérifier la pluie
                if (rainProb > 60) {
                    return "🌧️"; // Forte probabilité de pluie
                } else if (rainProb > 30) {
                    return "🌦️"; // Probabilité modérée de pluie
                }

                // Ensuite traiter selon le code météo
                // Mais ajuster pour le code 3 (couvert) si conditions agréables
                if (weatherCode === 3) {
                    // Si couvert mais peu de pluie et température douce
                    if (rainProb < 10 && maxTemp >= 15) {
                        return "⛅"; // Partiellement nuageux au lieu de totalement couvert
                    }
                    // Sinon garder nuageux
                    return "☁️";
                }

                // Pour les autres codes, utiliser le mapping standard
                const emojiIcons = {
                    0: "☀️",
                    1: "🌤️",
                    2: "⛅",
                    45: "🌫️",
                    48: "🌫️",
                    51: "🌦️",
                    53: "🌦️",
                    55: "🌦️",
                    61: "🌧️",
                    63: "🌧️",
                    65: "🌧️",
                    71: "🌨️",
                    73: "🌨️",
                    75: "🌨️",
                    80: "🌦️",
                    81: "🌦️",
                    82: "🌦️",
                    95: "⛈️",
                    96: "⛈️",
                    99: "⛈️"
                };
                return emojiIcons[weatherCode] || "❓";
            }

            // Créer le HTML pour les jours
            let forecastHTML = "";
            const bestDays = [];

            for (let i = 0; i < days; i++) {
                const date = new Date(daily.time[i]);
                const dayIndex = date.getDay();
                const weatherCode = daily.weather_code ? daily.weather_code[i] : 0;
                const maxTemp = Math.round(daily.temperature_2m_max[i]);
                const minTemp = Math.round(daily.temperature_2m_min[i]);
                const rainProb = daily.precipitation_probability_max ? daily.precipitation_probability_max[i] : 0;
                const rainAmount = daily.precipitation_sum ? daily.precipitation_sum[i].toFixed(1) : 0;

                // Déterminer le nom du jour
                const dayName = i === 0 ? "AUJOURD'HUI" : dayNames[dayIndex];

                // Ajouter aux meilleurs jours si peu de pluie
                if (rainProb < 30) {
                    bestDays.push(i === 0 ? "Aujourd'hui" : dayNamesFull[dayIndex]);
                }

                // Créer le HTML pour ce jour
                forecastHTML += `
                    <div class="forecast-day ${i === 0 ? 'today' : ''}">
                        <div class="forecast-day-name">${dayName}</div>
                        <div class="forecast-icon">${getWeatherEmoji(weatherCode, rainProb, maxTemp)}</div>
                        <div class="forecast-temps">
                            <span class="temp-max">${maxTemp}°</span>
                            <span style="color: #888;">/</span>
                            <span class="temp-min">${minTemp}°</span>
                        </div>
                        ${rainProb > 0 ? `<div class="forecast-rain">☂ ${rainProb}%</div>` : '<div class="forecast-rain">&nbsp;</div>'}
                    </div>
                `;
            }

            // Insérer le HTML
            document.getElementById('forecast-container').innerHTML = forecastHTML;

            // Créer le résumé
            let summaryHTML = "";
            if (bestDays.length > 0) {
                summaryHTML = `✓ MEILLEURS JOURS: ${bestDays.join(", ")}`;
            } else {
                summaryHTML = "⚠ Semaine pluvieuse - Prévoir parapluie";
            }

            // Ajouter info sur la tendance générale
            const avgRainProb = daily.precipitation_probability_max.slice(0, days).reduce((a, b) => a + b, 0) / days;
            const avgMaxTemp = daily.temperature_2m_max.slice(0, days).reduce((a, b) => a + b, 0) / days;

            summaryHTML += ` | Temp moy: ${Math.round(avgMaxTemp)}° | Pluie moy: ${Math.round(avgRainProb)}%`;

            document.getElementById('forecast-summary').innerHTML = summaryHTML;
        }

        // Calculer les recommandations d'activités
        function calculateActivities(data) {
            const current = data.current;
            const daily = data.daily;
            const temp = current.temperature_2m;
            const rain = current.precipitation;
            const wind = current.wind_speed_10m;
            const humidity = current.relative_humidity_2m;
            const uvIndex = current.uv_index || 0;

            return {
                sport: rain < 0.1 && wind < 25 && uvIndex < 8 ? "PARFAIT" : rain < 1 ? "ACCEPTABLE" : "REPORTER",
                picnic: temp > 15 && rain < 0.1 && uvIndex < 6 ? "IDEAL" : temp > 10 ? "PREVOIR PULL" : "TROP FROID",
                garden: rain < 0.1 && wind < 20 && temp > 5 ? "IDEAL" : "ATTENDRE",
                laundry: rain < 0.1 && wind > 5 ? "SECHERA EN 3H" : rain < 0.1 ? "SECHERA LENTEMENT" : "REPORTER",
                bbq: rain < 0.1 && wind < 15 ? "GO" : "REPORTER",
                car: rain < 0.1 ? "GO" : "ATTENDRE 2J",
                ventilate: temp > 20 || humidity > 70 ? "OUI - RAFRAICHIR" : temp < 10 ? "NON - TROP FROID" : "OPTIONNEL",
                watering: rain > 2 ? "INUTILE" : temp > 25 || humidity < 40 ? "URGENT" : "OPTIONNEL",
                drying: rain < 0.1 && wind > 10 && humidity < 60 ? "PARFAIT" : rain < 0.1 ? "LENT" : "IMPOSSIBLE"
            };
        }

        // Système de cache pour limiter les appels API
        const CACHE_KEY = 'meteo_amiens_cache';
        const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes en millisecondes

        function getCachedData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    const now = Date.now();
                    // Vérifier si le cache est encore valide
                    if (now - timestamp < CACHE_DURATION) {
                        console.log('Utilisation du cache (valide pendant', Math.round((CACHE_DURATION - (now - timestamp)) / 1000), 'secondes)');
                        return data;
                    } else {
                        console.log('Cache expiré, nouvelle requête API');
                    }
                }
            } catch (error) {
                console.error('Erreur lecture cache:', error);
            }
            return null;
        }

        function setCachedData(data) {
            try {
                const cacheObject = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheObject));
                console.log('Données mises en cache');
            } catch (error) {
                console.error('Erreur écriture cache:', error);
            }
        }

        async function loadWeatherData(forceRefresh = false) {
            try {
                let data = null;

                // Essayer de récupérer depuis le cache sauf si forceRefresh est activé
                if (!forceRefresh) {
                    data = getCachedData();
                }

                // Si pas de données en cache ou forceRefresh, faire un appel API
                if (!data) {
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/forecast?latitude=${AMIENS_LAT}&longitude=${AMIENS_LON}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,cloud_cover,pressure_msl,wind_speed_10m,wind_direction_10m,wind_gusts_10m,uv_index,visibility&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,sunrise,sunset,uv_index_max,weather_code&hourly=temperature_2m,precipitation_probability,precipitation,wind_speed_10m,weather_code,is_day&timezone=Europe%2FParis&forecast_days=7`
                    );

                    if (!response.ok) {
                        throw new Error('Erreur chargement données');
                    }

                    data = await response.json();
                    // Mettre en cache les nouvelles données
                    setCachedData(data);
                }

                displayWeatherData(data);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('weather-content').style.display = 'block';

                // Afficher l'heure de dernière mise à jour depuis les données
                const cacheInfo = getCachedData() ? ' (depuis cache)' : ' (nouvelles données)';
                document.getElementById('timestamp').textContent =
                    `DERNIERE MAJ: ${new Date().toLocaleString('fr-FR')}${cacheInfo}`;

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').innerHTML =
                    '<span style="color: #ff0000;">ERREUR CONNEXION SATELLITE - RETRY...</span>';
            }
        }

        function displayWeatherData(data) {
            const current = data.current;
            const daily = data.daily;

            // Température
            document.getElementById('temp-current').textContent = `${Math.round(current.temperature_2m)}°C`;
            document.getElementById('temp-feels').textContent = `${Math.round(current.apparent_temperature)}°C`;
            document.getElementById('temp-minmax').textContent = `${Math.round(daily.temperature_2m_min[0])}°C / ${Math.round(daily.temperature_2m_max[0])}°C`;

            // Précipitations
            const rainProb = daily.precipitation_probability_max[0] || 0;
            document.getElementById('rain-prob').textContent = `${rainProb}%`;
            document.getElementById('rain-amount').textContent = current.precipitation > 0 ? `${current.precipitation.toFixed(1)} mm` : "< 0.1 mm";
            document.getElementById('umbrella-needed').textContent = rainProb > 70 ? "OUI" : "NON";

            // Vent
            document.getElementById('wind-speed').textContent = `${Math.round(current.wind_speed_10m)} km/h`;
            document.getElementById('wind-gusts').textContent = `${Math.round(current.wind_gusts_10m)} km/h`;
            document.getElementById('wind-direction').textContent = getWindDirection(current.wind_direction_10m);
            document.getElementById('wind-class').textContent = getWindClassification(current.wind_speed_10m);
            document.getElementById('wind-danger').textContent = current.wind_speed_10m > 50 ? "OUI" : "NON";

            // Visibilité et phares
            const visibility = current.visibility || 10000;
            const visibilityKm = (visibility / 1000).toFixed(1);
            document.getElementById('visibility').textContent = visibility > 1000 ? `${visibilityKm} km` : `${visibility} m`;
            document.getElementById('headlights').textContent = visibility < 1000 ? "OUI" : "NON";
            if (visibility < 1000) {
                document.getElementById('headlights').className = 'value warning';
            }

            // Indice UV
            const uvIndex = current.uv_index || 0;
            const uvMax = daily.uv_index_max ? daily.uv_index_max[0] : 0;
            document.getElementById('uv-index').textContent = `${uvIndex.toFixed(1)} (max: ${uvMax.toFixed(1)})`;
            document.getElementById('sunscreen').textContent = uvIndex > 2 ? "OUI" : "NON";
            if (uvIndex > 2) {
                document.getElementById('sunscreen').className = 'value warning';
            }

            // Heures soleil
            if (daily.sunrise && daily.sunset) {
                const sunrise = new Date(daily.sunrise[0]);
                const sunset = new Date(daily.sunset[0]);
                const now = new Date();

                document.getElementById('sunrise').textContent = sunrise.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('sunset').textContent = sunset.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                if (now < sunset && now > sunrise) {
                    const remaining = (sunset - now) / (1000 * 60 * 60);
                    const hours = Math.floor(remaining);
                    const minutes = Math.floor((remaining - hours) * 60);
                    document.getElementById('daylight-remaining').textContent = `${hours}h${minutes < 10 ? '0' : ''}${minutes}`;
                } else {
                    document.getElementById('daylight-remaining').textContent = "NUIT";
                }
            }

            // ASCII Art et description météo
            const visualization = getWeatherVisualization(
                current.weather_code,
                current.is_day === 1,
                current.precipitation,
                current.cloud_cover,
                current.wind_speed_10m
            );
            document.getElementById('weather-icon').textContent = visualization.emoji;
            document.getElementById('weather-description').textContent = visualization.description;

            // Alertes météo
            displayAlerts(data);

            // Prévisions horaires
            if (data.hourly) {
                displayHourlyForecast(data.hourly);
            }

            // Graphique prévisions 7 jours
            if (data.daily) {
                displayWeeklyForecast(data.daily);
            }

            // Activités
            const activities = calculateActivities(data);
            document.getElementById('activity-sport').textContent = activities.sport;
            document.getElementById('activity-picnic').textContent = activities.picnic;
            document.getElementById('activity-garden').textContent = activities.garden;
            document.getElementById('activity-laundry').textContent = activities.laundry;
            document.getElementById('activity-bbq').textContent = activities.bbq;
            document.getElementById('activity-car').textContent = activities.car;
            document.getElementById('activity-ventilate').textContent = activities.ventilate;
            document.getElementById('activity-watering').textContent = activities.watering;
            document.getElementById('activity-drying').textContent = activities.drying;

            // Colorer selon les résultats
            ['sport', 'picnic', 'garden', 'laundry', 'bbq', 'car', 'ventilate', 'watering', 'drying'].forEach(activity => {
                const element = document.getElementById(`activity-${activity}`);
                const text = element.textContent;
                if (text.includes('PARFAIT') || text.includes('IDEAL') || text.includes('GO') || text.includes('OUI') && !text.includes('NON')) {
                    element.className = 'status-ok';
                } else if (text.includes('PREVOIR') || text.includes('ATTENDRE') || text.includes('LENTEMENT') || text.includes('OPTIONNEL') || text.includes('LENT') || text.includes('URGENT')) {
                    element.className = 'status-caution';
                } else {
                    element.className = 'status-bad';
                }
            });
        }


        // Charger les données au démarrage
        loadWeatherData();

        // Actualiser toutes les 10 minutes (force le rafraîchissement depuis l'API)
        setInterval(() => loadWeatherData(true), 600000);

        // Vérifier le cache toutes les 30 secondes pour mettre à jour le compteur
        setInterval(() => {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const { timestamp } = JSON.parse(cached);
                const now = Date.now();
                const remaining = Math.round((CACHE_DURATION - (now - timestamp)) / 1000);
                if (remaining > 0) {
                    console.log('Cache valide pendant encore', remaining, 'secondes');
                }
            }
        }, 30000);
    </script>
</body>
</html>