<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©t√©o Amiens - Temps r√©el</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F1Z1EG4HZS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-F1Z1EG4HZS');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            line-height: 1.4;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border: double 3px #00ff00;
            padding: 15px;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 12px;
            color: #ffff00;
        }

        .timestamp {
            color: #888;
            margin-top: 10px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .panel {
            border: solid 1px #00ff00;
            padding: 20px;
            background: rgba(0, 255, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .data-line {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .label {
            color: #ccc;
        }

        .value {
            color: #00ff00;
            font-weight: bold;
        }

        .value.warning {
            color: #ffff00;
        }

        .value.danger {
            color: #ff0000;
        }

        .weather-visual {
            margin: 30px 0;
            border: double 3px #00ff00;
            padding: 20px;
            text-align: center;
        }

        .visual-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .weather-icon {
            font-size: 4em;
            line-height: 1.2;
            margin: 20px auto;
            text-align: center;
        }

        .weather-description {
            color: #ffff00;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
        }

        .alerts-section {
            margin: 20px 0;
            border: solid 2px #ff0000;
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
        }

        .alert-title {
            color: #ff0000;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .alerts-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .alert-item {
            color: #ffff00;
            padding: 5px;
            border-left: 3px solid #ff0000;
            padding-left: 10px;
        }

        .sun-info {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #333;
            background: rgba(255, 255, 0, 0.05);
        }

        .sun-item {
            text-align: center;
        }

        .sun-label {
            color: #888;
            font-size: 12px;
        }

        .sun-value {
            color: #ffff00;
            font-weight: bold;
            font-size: 16px;
        }

        .forecast-section {
            margin: 30px 0;
            padding: 20px;
            border: double 3px #00ff00;
            background: rgba(0, 255, 0, 0.02);
        }

        .forecast-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }

        .forecast-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            font-family: 'Roboto Mono', 'Courier New', monospace;
            color: #00ff00;
        }

        .forecast-day {
            border: 1px solid #333;
            padding: 15px 5px;
            text-align: center;
            background: rgba(0, 255, 0, 0.01);
        }

        .forecast-day.today {
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.05);
        }

        .forecast-day-name {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .forecast-icon {
            font-size: 32px;
            margin: 10px 0;
            line-height: 1;
        }

        .forecast-temps {
            margin: 10px 0;
            font-size: 14px;
        }

        .temp-max {
            color: #ff6666;
            font-weight: bold;
        }

        .temp-min {
            color: #6666ff;
        }

        .forecast-rain {
            color: #00ffff;
            font-size: 12px;
            margin-top: 5px;
        }

        .forecast-summary {
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #333;
            text-align: center;
            color: #ffff00;
        }

        .hourly-forecast {
            margin: 30px 0;
            padding: 20px;
            border: double 3px #00ff00;
            background: rgba(0, 255, 0, 0.02);
        }

        .hourly-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }

        .hourly-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .hourly-item {
            border: 1px solid #333;
            padding: 15px 10px;
            text-align: center;
            background: rgba(0, 255, 0, 0.01);
        }

        .hourly-item.current {
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.05);
        }

        .hourly-period {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .hourly-time {
            color: #888;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .hourly-icon {
            font-size: 28px;
            margin: 10px 0;
            line-height: 1;
        }

        .hourly-temp {
            color: #00ff00;
            font-weight: bold;
            font-size: 16px;
            margin: 5px 0;
        }

        .hourly-rain {
            color: #00ffff;
            font-size: 12px;
            margin-top: 5px;
        }

        .hourly-wind {
            color: #888;
            font-size: 11px;
            margin-top: 3px;
        }

        @media (max-width: 900px) {
            .forecast-container {
                grid-template-columns: repeat(4, 1fr);
            }
            .hourly-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .forecast-container {
                grid-template-columns: repeat(2, 1fr);
            }
            .hourly-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .activity-section {
            margin: 30px 0;
            border: solid 1px #888;
            padding: 20px;
        }

        .activity-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #333;
            background: rgba(0, 255, 0, 0.02);
        }

        .status-ok { color: #00ff00; }
        .status-caution { color: #ffff00; }
        .status-bad { color: #ff0000; }

        .footer {
            margin-top: 40px;
            text-align: center;
            color: #666;
            border-top: 1px solid #333;
            padding-top: 20px;
        }

        .ascii-art {
            color: #888;
            font-size: 10px;
            text-align: center;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre;
            line-height: 1.2;
        }

        .loading {
            color: #ffff00;
            text-align: center;
            margin: 20px 0;
        }

        .city-selector {
            position: relative;
            display: inline-block;
            margin-left: 20px;
        }

        .city-input {
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 5px 10px;
            font-family: inherit;
            font-size: 11px;
            width: 200px;
            outline: none;
        }

        .city-input::placeholder {
            color: #666;
        }

        .city-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #000;
            border: 1px solid #00ff00;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .city-suggestion {
            padding: 8px 10px;
            cursor: pointer;
            color: #00ff00;
            font-size: 11px;
            border-bottom: 1px solid #333;
        }

        .city-suggestion:hover,
        .city-suggestion.selected {
            background: rgba(0, 255, 0, 0.1);
        }

        .city-suggestion:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            body {
                font-size: 12px;
                padding: 10px;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .activity-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">‚ïê‚ïê‚ïê METEO <span id="city-name">AMIENS</span> ‚ïê‚ïê‚ïê
                <div class="city-selector">
                    <input type="text" class="city-input" id="city-input" placeholder="Changer de ville...">
                    <div class="city-suggestions" id="city-suggestions"></div>
                </div>
            </div>
            <div class="subtitle">Donn√©es en temps r√©el</div>
            <div class="timestamp" id="timestamp">DERNIERE MAJ: --</div>
            <button onclick="loadWeatherData(true)" style="background: transparent; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; margin-top: 10px; cursor: pointer; font-family: inherit; font-size: 11px;">‚Üª RAFRAICHIR</button>
        </div>

        <div class="loading" id="loading">
            CHARGEMENT DES DONNEES SATELLITAIRES...
            [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 100%
        </div>

        <div id="weather-content" style="display: none;">
            <div class="weather-visual">
                <div class="visual-title">[ CONDITIONS ACTUELLES ]</div>
                <div class="weather-icon" id="weather-icon">
                    <!-- Emoji m√©t√©o sera ins√©r√© ici par JavaScript -->
                </div>
                <div class="weather-description" id="weather-description">
                    <!-- Description sera ins√©r√©e ici -->
                </div>
                <div class="sun-info">
                    <div class="sun-item">
                        <div class="sun-label">LEVER</div>
                        <div class="sun-value" id="sunrise">--:--</div>
                    </div>
                    <div class="sun-item">
                        <div class="sun-label">COUCHER</div>
                        <div class="sun-value" id="sunset">--:--</div>
                    </div>
                    <div class="sun-item">
                        <div class="sun-label">LUMIERE RESTANTE</div>
                        <div class="sun-value" id="daylight-remaining">--h--</div>
                    </div>
                </div>
            </div>

            <div class="hourly-forecast">
                <div class="hourly-title">[ PREVISIONS PROCHAINES HEURES ]</div>
                <div class="hourly-container" id="hourly-container">
                    <!-- Pr√©visions horaires seront ins√©r√©es ici -->
                </div>
            </div>

            <div class="alerts-section" id="alerts-section" style="display: none;">
                <div class="alert-title">[ ALERTES ]</div>
                <div class="alerts-grid" id="alerts-grid">
                    <!-- Alertes dynamiques -->
                </div>
            </div>

            <div class="main-grid">
                <div class="panel">
                    <div class="panel-title">[ TEMPERATURE ]</div>
                    <div class="data-line">
                        <span class="label">ACTUELLE:</span>
                        <span class="value" id="temp-current">--¬∞C</span>
                    </div>
                    <div class="data-line">
                        <span class="label">RESSENTIE:</span>
                        <span class="value" id="temp-feels">--¬∞C</span>
                    </div>
                    <div class="data-line">
                        <span class="label">MIN/MAX:</span>
                        <span class="value" id="temp-minmax">--¬∞C / --¬∞C</span>
                    </div>
                    <div class="data-line">
                        <span class="label">TENDANCE 3H:</span>
                        <span class="value" id="temp-trend">STABLE</span>
                    </div>
                    <div class="data-line">
                        <span class="label">NORMAL SAISON:</span>
                        <span class="value" id="temp-normal">OUI</span>
                    </div>
                    <div class="data-line">
                        <span class="label">INDICE UV:</span>
                        <span class="value" id="uv-index">--</span>
                    </div>
                    <div class="data-line">
                        <span class="label">CREME SOLAIRE:</span>
                        <span class="value" id="sunscreen">NON</span>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">[ PRECIPITATIONS ]</div>
                    <div class="data-line">
                        <span class="label">PROBABILITE:</span>
                        <span class="value" id="rain-prob">--%</span>
                    </div>
                    <div class="data-line">
                        <span class="label">QUANTITE SI PLUIE:</span>
                        <span class="value" id="rain-amount">-- mm</span>
                    </div>
                    <div class="data-line">
                        <span class="label">DERNIERE PLUIE:</span>
                        <span class="value" id="last-rain">-- JOURS</span>
                    </div>
                    <div class="data-line">
                        <span class="label">CUMUL SEMAINE:</span>
                        <span class="value" id="week-rain">-- mm</span>
                    </div>
                    <div class="data-line">
                        <span class="label">PARAPLUIE REQUIS:</span>
                        <span class="value" id="umbrella-needed">NON</span>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">[ VENT & VISIBILITE ]</div>
                    <div class="data-line">
                        <span class="label">VITESSE MOYENNE:</span>
                        <span class="value" id="wind-speed">-- km/h</span>
                    </div>
                    <div class="data-line">
                        <span class="label">RAFALES MAX:</span>
                        <span class="value" id="wind-gusts">-- km/h</span>
                    </div>
                    <div class="data-line">
                        <span class="label">DIRECTION:</span>
                        <span class="value" id="wind-direction">--</span>
                    </div>
                    <div class="data-line">
                        <span class="label">CLASSIFICATION:</span>
                        <span class="value" id="wind-class">BRISE LEGERE</span>
                    </div>
                    <div class="data-line">
                        <span class="label">DANGEREUX:</span>
                        <span class="value" id="wind-danger">NON</span>
                    </div>
                    <div class="data-line">
                        <span class="label">VISIBILITE:</span>
                        <span class="value" id="visibility">-- km</span>
                    </div>
                    <div class="data-line">
                        <span class="label">PHARES REQUIS:</span>
                        <span class="value" id="headlights">NON</span>
                    </div>
                </div>
            </div>

            <div class="forecast-section">
                <div class="forecast-title">[ PREVISIONS 7 JOURS ]</div>
                <div class="forecast-container" id="forecast-container">
                    <!-- Pr√©visions 7 jours seront ins√©r√©es ici -->
                </div>
                <div class="forecast-summary" id="forecast-summary">
                    <!-- R√©sum√© des pr√©visions -->
                </div>
            </div>

            <div class="panel" style="margin: 30px auto; max-width: 600px;">
                <div class="panel-title">[ HUMIDITE & CONFORT ]</div>
                <div class="data-line">
                    <span class="label">HUMIDITE:</span>
                    <span class="value" id="humidity-current">--%</span>
                </div>
                <div class="data-line">
                    <span class="label">SENSATION:</span>
                    <span class="value" id="humidity-comfort">--</span>
                </div>
                <div class="data-line">
                    <span class="label">SECHOIR INTERIEUR:</span>
                    <span class="value" id="humidity-indoor-drying">--</span>
                </div>
                <div class="data-line">
                    <span class="label">AERER MAISON:</span>
                    <span class="value" id="humidity-ventilate">--</span>
                </div>
                <div class="data-line">
                    <span class="label">POINT DE ROSEE:</span>
                    <span class="value" id="dew-point">--¬∞C</span>
                </div>
                <div class="data-line">
                    <span class="label">RISQUE BROUILLARD:</span>
                    <span class="value" id="fog-risk">--</span>
                </div>
            </div>

            <div class="activity-section">
                <div class="activity-title">[ CONSEILS DU JOUR ]</div>
                <div class="activity-grid">
                    <div class="activity-item">
                        <span>TENUE ECOLE:</span>
                        <span class="status-ok" id="activity-school">T-SHIRT</span>
                    </div>
                    <div class="activity-item">
                        <span>VELO/FOOTING:</span>
                        <span class="status-ok" id="activity-sport">PARFAIT</span>
                    </div>
                    <div class="activity-item">
                        <span>PIQUE-NIQUE:</span>
                        <span class="status-caution" id="activity-picnic">PREVOIR PULL</span>
                    </div>
                    <div class="activity-item">
                        <span>BARBECUE:</span>
                        <span class="status-ok" id="activity-bbq">GO</span>
                    </div>
                    <div class="activity-item">
                        <span>JARDINAGE:</span>
                        <span class="status-ok" id="activity-garden">IDEAL</span>
                    </div>
                    <div class="activity-item">
                        <span>ARROSER JARDIN:</span>
                        <span class="status-caution" id="activity-watering">NON</span>
                    </div>
                    <div class="activity-item">
                        <span>SECHER LINGE DEHORS:</span>
                        <span class="status-ok" id="activity-drying">PARFAIT</span>
                    </div>
                    <div class="activity-item">
                        <span>RANDONNEE:</span>
                        <span class="status-ok" id="activity-hiking">IDEAL</span>
                    </div>
                    <div class="activity-item">
                        <span>BIVOUAC:</span>
                        <span class="status-caution" id="activity-camping">PREVOIR CHAUD</span>
                    </div>
                    <div class="activity-item">
                        <span>LAVER VOITURE:</span>
                        <span class="status-caution" id="activity-car">ATTENDRE 2J</span>
                    </div>
                </div>
            </div>

            <div class="ascii-art">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               M√©t√©o locale sans exag√©ration                ‚îÇ
‚îÇ               Donn√©es Open-Meteo.com fiables               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</div>
        </div>

        <div class="footer">
            <div>Station <span id="footer-city">Amiens</span> - Coordonn√©es: <span id="footer-coords">49.9¬∞N, 2.3¬∞E</span></div>
            <div>Source: Open-Meteo.com | Mise √† jour: 10 minutes</div>
        </div>
    </div>

    <script>
        // Configuration g√©ographique dynamique
        let currentCity = {
            name: "AMIENS",
            lat: 49.9,
            lon: 2.3
        };

        // Syst√®me de cache par ville
        const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes en millisecondes

        function getCacheKey() {
            return `meteo_${currentCity.name.toLowerCase()}_cache`;
        }


        // Classification des vents selon √©chelle de Beaufort
        function getWindClassification(speed) {
            if (speed < 6) return "CALME";
            if (speed < 12) return "BRISE LEGERE";
            if (speed < 20) return "BRISE MODEREE";
            if (speed < 29) return "BONNE BRISE";
            if (speed < 39) return "VENT FRAIS";
            if (speed < 50) return "VENT FORT";
            return "TEMPETE";
        }

        // Direction du vent en texte
        function getWindDirection(degrees) {
            const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSO", "SO", "OSO", "O", "ONO", "NO", "NNO"];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        // D√©terminer l'emoji et la description selon le code m√©t√©o
        function getWeatherVisualization(weatherCode, isDay, precipitation, cloudCover, windSpeed) {
            let emoji = "";
            let description = "";

            // Codes m√©t√©o WMO
            // 0: Clear sky
            // 1, 2, 3: Mainly clear, partly cloudy, and overcast
            // 45, 48: Fog and depositing rime fog
            // 51, 53, 55: Drizzle: Light, moderate, and dense intensity
            // 61, 63, 65: Rain: Slight, moderate and heavy intensity
            // 71, 73, 75: Snow fall: Slight, moderate, and heavy intensity
            // 80, 81, 82: Rain showers: Slight, moderate, and violent
            // 95: Thunderstorm: Slight or moderate
            // 96, 99: Thunderstorm with slight and heavy hail

            if (!isDay) {
                emoji = "üåô";
                description = "NUIT ";
            }

            switch(weatherCode) {
                case 0:
                    if (isDay) {
                        emoji = "‚òÄÔ∏è";
                        description = "ENSOLEILLE";
                    } else {
                        description += "CLAIRE";
                    }
                    break;
                case 1:
                case 2:
                    if (isDay) {
                        emoji = "üå§Ô∏è";
                        description = "PARTIELLEMENT NUAGEUX";
                    } else {
                        description += "PARTIELLEMENT NUAGEUSE";
                    }
                    break;
                case 3:
                    emoji = "‚òÅÔ∏è";
                    description = isDay ? "NUAGEUX" : description + "NUAGEUSE";
                    break;
                case 45:
                case 48:
                    emoji = "üå´Ô∏è";
                    description = "BROUILLARD";
                    break;
                case 51:
                case 53:
                case 55:
                    emoji = "üå¶Ô∏è";
                    description = "BRUINE";
                    break;
                case 61:
                case 63:
                case 65:
                    emoji = "üåßÔ∏è";
                    description = weatherCode === 65 ? "FORTE PLUIE" : "PLUIE";
                    break;
                case 71:
                case 73:
                case 75:
                    emoji = "üå®Ô∏è";
                    description = "NEIGE";
                    break;
                case 80:
                case 81:
                case 82:
                    emoji = "üå¶Ô∏è";
                    description = "AVERSES";
                    break;
                case 95:
                case 96:
                case 99:
                    emoji = "‚õàÔ∏è";
                    description = "ORAGE";
                    break;
                default:
                    // Fallback bas√© sur d'autres param√®tres
                    if (precipitation > 0.5) {
                        emoji = "üåßÔ∏è";
                        description = "PLUVIEUX";
                    } else if (cloudCover > 70) {
                        emoji = "‚òÅÔ∏è";
                        description = "TRES NUAGEUX";
                    } else if (cloudCover > 30) {
                        emoji = "‚õÖ";
                        description = "PARTIELLEMENT NUAGEUX";
                    } else if (windSpeed > 30) {
                        emoji = "üí®";
                        description = "VENTEUX";
                    } else {
                        emoji = isDay ? "‚òÄÔ∏è" : "üåô";
                        description = isDay ? "CLAIR" : "NUIT CLAIRE";
                    }
            }

            return { emoji, description };
        }

        // Afficher les alertes m√©t√©o
        function displayAlerts(data) {
            const alerts = [];
            const current = data.current;
            const daily = data.daily;

            // Alerte gel
            if (daily.temperature_2m_min[0] <= 0) {
                alerts.push(`‚ö†Ô∏è GEL NOCTURNE: ${daily.temperature_2m_min[0].toFixed(1)}¬∞C - Prot√©ger plantes et pare-brise`);
            }

            // Alerte canicule
            if (daily.temperature_2m_max[0] >= 35) {
                alerts.push(`‚ö†Ô∏è FORTE CHALEUR: ${daily.temperature_2m_max[0].toFixed(1)}¬∞C - Hydratation importante`);
            }

            // Alerte temp√™te
            if (current.wind_gusts_10m > 70) {
                alerts.push(`‚ö†Ô∏è RAFALES VIOLENTES: ${Math.round(current.wind_gusts_10m)} km/h - √âviter d√©placements`);
            }

            // Alerte visibilit√©
            if (current.visibility && current.visibility < 200) {
                alerts.push(`‚ö†Ô∏è BROUILLARD DENSE: Visibilit√© ${current.visibility}m - Conduite dangereuse`);
            }

            // Alerte UV
            if (current.uv_index && current.uv_index > 7) {
                alerts.push(`‚ö†Ô∏è UV EXTREMES: Indice ${current.uv_index.toFixed(1)} - Protection maximale requise`);
            }

            const alertsSection = document.getElementById('alerts-section');
            const alertsGrid = document.getElementById('alerts-grid');

            if (alerts.length > 0) {
                alertsSection.style.display = 'block';
                alertsGrid.innerHTML = alerts.map(alert => `<div class="alert-item">${alert}</div>`).join('');
            } else {
                alertsSection.style.display = 'none';
            }
        }

        // Fonction pour d√©terminer les p√©riodes de la journ√©e
        function getHourlyPeriods(hourlyData) {
            const now = new Date();
            const currentHour = now.getHours();
            const periods = [];

            // D√©terminer les heures cibles selon l'heure actuelle
            const targetHours = [];

            // Ajouter "Maintenant"
            targetHours.push({
                hour: currentHour,
                label: "MAINTENANT",
                isCurrent: true
            });

            // D√©terminer les prochaines p√©riodes pertinentes
            if (currentHour < 12) {
                targetHours.push({ hour: 12, label: "MIDI" });
                targetHours.push({ hour: 15, label: "APRES-MIDI" });
                targetHours.push({ hour: 19, label: "SOIREE" });
                targetHours.push({ hour: 23, label: "NUIT" });
            } else if (currentHour < 15) {
                targetHours.push({ hour: 15, label: "APRES-MIDI" });
                targetHours.push({ hour: 19, label: "SOIREE" });
                targetHours.push({ hour: 23, label: "NUIT" });
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
            } else if (currentHour < 19) {
                targetHours.push({ hour: 19, label: "SOIREE" });
                targetHours.push({ hour: 23, label: "NUIT" });
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
                targetHours.push({ hour: 12, label: "DEMAIN MIDI", nextDay: true });
            } else if (currentHour < 23) {
                targetHours.push({ hour: 23, label: "NUIT" });
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
                targetHours.push({ hour: 12, label: "DEMAIN MIDI", nextDay: true });
                targetHours.push({ hour: 15, label: "DEMAIN APM", nextDay: true });
            } else {
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
                targetHours.push({ hour: 12, label: "DEMAIN MIDI", nextDay: true });
                targetHours.push({ hour: 15, label: "DEMAIN APM", nextDay: true });
                targetHours.push({ hour: 19, label: "DEMAIN SOIR", nextDay: true });
            }

            // Limiter √† 5 p√©riodes maximum
            return targetHours.slice(0, 5);
        }

        // Fonction pour obtenir l'emoji m√©t√©o horaire
        function getHourlyWeatherEmoji(weatherCode, isDay) {
            const emojiIcons = {
                0: isDay ? "‚òÄÔ∏è" : "üåô",
                1: isDay ? "üå§Ô∏è" : "üåô",
                2: isDay ? "‚õÖ" : "‚òÅÔ∏è",
                3: "‚òÅÔ∏è",
                45: "üå´Ô∏è",
                48: "üå´Ô∏è",
                51: "üå¶Ô∏è",
                53: "üå¶Ô∏è",
                55: "üå¶Ô∏è",
                61: "üåßÔ∏è",
                63: "üåßÔ∏è",
                65: "üåßÔ∏è",
                71: "üå®Ô∏è",
                73: "üå®Ô∏è",
                75: "üå®Ô∏è",
                80: "üå¶Ô∏è",
                81: "üå¶Ô∏è",
                82: "üå¶Ô∏è",
                95: "‚õàÔ∏è",
                96: "‚õàÔ∏è",
                99: "‚õàÔ∏è"
            };
            return emojiIcons[weatherCode] || "‚ùì";
        }

        // Afficher les pr√©visions horaires
        function displayHourlyForecast(hourlyData) {
            if (!hourlyData || !hourlyData.time) return;

            const periods = getHourlyPeriods(hourlyData);
            const now = new Date();
            let hourlyHTML = "";

            periods.forEach(period => {
                // Calculer l'index dans les donn√©es horaires
                let targetDate = new Date();
                if (period.nextDay) {
                    targetDate.setDate(targetDate.getDate() + 1);
                }
                targetDate.setHours(period.hour, 0, 0, 0);

                // Trouver l'index correspondant dans les donn√©es
                const targetTimeString = targetDate.toISOString().slice(0, 13) + ":00";
                const dataIndex = hourlyData.time.findIndex(t => t === targetTimeString);

                if (dataIndex === -1) return;

                const temp = Math.round(hourlyData.temperature_2m[dataIndex]);
                const rainProb = hourlyData.precipitation_probability[dataIndex] || 0;
                const rainAmount = hourlyData.precipitation[dataIndex] || 0;
                const windSpeed = Math.round(hourlyData.wind_speed_10m[dataIndex]);
                const weatherCode = hourlyData.weather_code ? hourlyData.weather_code[dataIndex] : 0;
                const isDay = hourlyData.is_day ? hourlyData.is_day[dataIndex] === 1 : (period.hour >= 7 && period.hour <= 20);

                // Format de l'heure
                const timeStr = period.hour.toString().padStart(2, '0') + ':00';

                hourlyHTML += `
                    <div class="hourly-item ${period.isCurrent ? 'current' : ''}">
                        <div class="hourly-period">${period.label}</div>
                        <div class="hourly-time">${timeStr}</div>
                        <div class="hourly-icon">${getHourlyWeatherEmoji(weatherCode, isDay)}</div>
                        <div class="hourly-temp">${temp}¬∞</div>
                        ${rainProb > 0 ? `<div class="hourly-rain">‚òÇ ${rainProb}%</div>` : '<div class="hourly-rain">&nbsp;</div>'}
                        <div class="hourly-wind">üí® ${windSpeed} km/h</div>
                    </div>
                `;
            });

            document.getElementById('hourly-container').innerHTML = hourlyHTML;
        }

        // Afficher pr√©visions 7 jours
        function displayWeeklyForecast(daily) {
            const days = 7;
            const dayNames = ['DIM', 'LUN', 'MAR', 'MER', 'JEU', 'VEN', 'SAM'];
            const dayNamesFull = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

            // Fonction intelligente pour obtenir l'ic√¥ne m√©t√©o selon plusieurs crit√®res
            function getWeatherEmoji(weatherCode, rainProb, maxTemp) {
                // D'abord v√©rifier la pluie
                if (rainProb > 60) {
                    return "üåßÔ∏è"; // Forte probabilit√© de pluie
                } else if (rainProb > 30) {
                    return "üå¶Ô∏è"; // Probabilit√© mod√©r√©e de pluie
                }

                // Ensuite traiter selon le code m√©t√©o
                // Mais ajuster pour le code 3 (couvert) si conditions agr√©ables
                if (weatherCode === 3) {
                    // Si couvert mais peu de pluie et temp√©rature douce
                    if (rainProb < 10 && maxTemp >= 15) {
                        return "‚õÖ"; // Partiellement nuageux au lieu de totalement couvert
                    }
                    // Sinon garder nuageux
                    return "‚òÅÔ∏è";
                }

                // Pour les autres codes, utiliser le mapping standard
                const emojiIcons = {
                    0: "‚òÄÔ∏è",
                    1: "üå§Ô∏è",
                    2: "‚õÖ",
                    45: "üå´Ô∏è",
                    48: "üå´Ô∏è",
                    51: "üå¶Ô∏è",
                    53: "üå¶Ô∏è",
                    55: "üå¶Ô∏è",
                    61: "üåßÔ∏è",
                    63: "üåßÔ∏è",
                    65: "üåßÔ∏è",
                    71: "üå®Ô∏è",
                    73: "üå®Ô∏è",
                    75: "üå®Ô∏è",
                    80: "üå¶Ô∏è",
                    81: "üå¶Ô∏è",
                    82: "üå¶Ô∏è",
                    95: "‚õàÔ∏è",
                    96: "‚õàÔ∏è",
                    99: "‚õàÔ∏è"
                };
                return emojiIcons[weatherCode] || "‚ùì";
            }

            // Cr√©er le HTML pour les jours
            let forecastHTML = "";
            const bestDays = [];

            for (let i = 0; i < days; i++) {
                const date = new Date(daily.time[i]);
                const dayIndex = date.getDay();
                const weatherCode = daily.weather_code ? daily.weather_code[i] : 0;
                const maxTemp = Math.round(daily.temperature_2m_max[i]);
                const minTemp = Math.round(daily.temperature_2m_min[i]);
                const rainProb = daily.precipitation_probability_max ? daily.precipitation_probability_max[i] : 0;
                const rainAmount = daily.precipitation_sum ? daily.precipitation_sum[i].toFixed(1) : 0;

                // D√©terminer le nom du jour
                const dayName = i === 0 ? "AUJOURD'HUI" : dayNames[dayIndex];

                // Ajouter aux meilleurs jours si peu de pluie
                if (rainProb < 30) {
                    bestDays.push(i === 0 ? "Aujourd'hui" : dayNamesFull[dayIndex]);
                }

                // Cr√©er le HTML pour ce jour
                forecastHTML += `
                    <div class="forecast-day ${i === 0 ? 'today' : ''}">
                        <div class="forecast-day-name">${dayName}</div>
                        <div class="forecast-icon">${getWeatherEmoji(weatherCode, rainProb, maxTemp)}</div>
                        <div class="forecast-temps">
                            <span class="temp-max">${maxTemp}¬∞</span>
                            <span style="color: #888;">/</span>
                            <span class="temp-min">${minTemp}¬∞</span>
                        </div>
                        ${rainProb > 0 ? `<div class="forecast-rain">‚òÇ ${rainProb}%</div>` : '<div class="forecast-rain">&nbsp;</div>'}
                    </div>
                `;
            }

            // Ins√©rer le HTML
            document.getElementById('forecast-container').innerHTML = forecastHTML;

            // Cr√©er le r√©sum√©
            let summaryHTML = "";
            if (bestDays.length > 0) {
                summaryHTML = `‚úì MEILLEURS JOURS: ${bestDays.join(", ")}`;
            } else {
                summaryHTML = "‚ö† Semaine pluvieuse - Pr√©voir parapluie";
            }

            // Ajouter info sur la tendance g√©n√©rale
            const avgRainProb = daily.precipitation_probability_max.slice(0, days).reduce((a, b) => a + b, 0) / days;
            const avgMaxTemp = daily.temperature_2m_max.slice(0, days).reduce((a, b) => a + b, 0) / days;

            summaryHTML += ` | Temp moy: ${Math.round(avgMaxTemp)}¬∞ | Pluie moy: ${Math.round(avgRainProb)}%`;

            document.getElementById('forecast-summary').innerHTML = summaryHTML;
        }

        // Calculer les recommandations d'activit√©s
        function calculateActivities(data) {
            const current = data.current;
            const daily = data.daily;
            const temp = current.temperature_2m;
            const rain = current.precipitation;
            const wind = current.wind_speed_10m;
            const humidity = current.relative_humidity_2m;
            const uvIndex = current.uv_index || 0;

            // Logique am√©lior√©e pour la tenue √©cole
            let schoolOutfit = "";

            // Utiliser les donn√©es horaires pour calculer temp matin et max journ√©e scolaire
            const hourly = data.hourly;
            const now = new Date();
            const currentHour = now.getHours();

            // Trouver temp√©rature du matin (8h-9h) ou actuelle si apr√®s 9h
            let morningTemp = temp;
            if (hourly && hourly.time && hourly.temperature_2m) {
                const todayMorning = hourly.time.findIndex(time => {
                    const hour = new Date(time).getHours();
                    return hour === 8 || hour === 9;
                });
                if (todayMorning !== -1) {
                    morningTemp = hourly.temperature_2m[todayMorning];
                }
            }

            // Max temp√©rature pendant les heures scolaires (9h-17h)
            let schoolMaxTemp = daily.temperature_2m_max[0];
            if (hourly && hourly.time && hourly.temperature_2m) {
                const schoolHours = [];
                hourly.time.forEach((time, index) => {
                    const hour = new Date(time).getHours();
                    const day = new Date(time).getDate();
                    const today = now.getDate();
                    if (day === today && hour >= 9 && hour <= 17) {
                        schoolHours.push(hourly.temperature_2m[index]);
                    }
                });
                if (schoolHours.length > 0) {
                    schoolMaxTemp = Math.max(...schoolHours);
                }
            }

            // Nouvelle logique bas√©e sur matin ET apr√®s-midi
            const tempDiff = schoolMaxTemp - morningTemp;

            if (morningTemp < 5) {
                schoolOutfit = "MANTEAU + ECHARPE";
            } else if (morningTemp < 10 && schoolMaxTemp > 18) {
                schoolOutfit = "VESTE + T-SHIRT (enlever midi)";
            } else if (morningTemp < 10) {
                schoolOutfit = "VESTE CHAUDE";
            } else if (morningTemp >= 10 && morningTemp < 15 && schoolMaxTemp > 20) {
                schoolOutfit = "GILET LEGER (enlever midi)";
            } else if (morningTemp < 15) {
                schoolOutfit = "GILET/PULL LEGER";
            } else if (schoolMaxTemp > 25) {
                schoolOutfit = "T-SHIRT + CASQUETTE";
            } else {
                schoolOutfit = "T-SHIRT SUFFISANT";
            }

            // Ajouter info pluie si n√©cessaire
            if (rain > 0.5 || daily.precipitation_probability_max[0] > 50) {
                schoolOutfit += " + IMPER";
            }

            // Logique pour randonn√©e
            let hiking = "";
            const visibility = current.visibility || 10000;
            if (rain < 0.1 && wind < 20 && temp >= 10 && temp <= 25 && visibility > 5000 && uvIndex < 8) {
                hiking = "IDEAL";
            } else if (rain < 1 && wind < 30 && temp >= 5 && temp <= 30 && visibility > 2000) {
                hiking = "ACCEPTABLE";
            } else if (rain > 5 || wind > 40 || temp < 0 || temp > 35 || visibility < 1000) {
                hiking = "DANGEREUX";
            } else {
                hiking = "DIFFICILE";
            }

            // Logique pour bivouac (plus exigeant)
            let camping = "";
            const minNightTemp = daily.temperature_2m_min[0];
            const rainProb = daily.precipitation_probability_max[0] || 0;

            if (rain < 0.1 && wind < 15 && temp >= 15 && minNightTemp >= 8 && rainProb < 20) {
                camping = "PARFAIT";
            } else if (rain < 0.5 && wind < 25 && minNightTemp >= 5 && rainProb < 40) {
                camping = "PREVOIR CHAUD";
            } else if (minNightTemp < 0) {
                camping = "GEL - EQUIPEMENT HIVER";
            } else if (rain > 2 || wind > 35 || rainProb > 70) {
                camping = "REPORTER";
            } else {
                camping = "CONDITIONS DIFFICILES";
            }

            return {
                school: schoolOutfit,
                sport: rain < 0.1 && wind < 25 && uvIndex < 8 ? "PARFAIT" : rain < 1 ? "ACCEPTABLE" : "REPORTER",
                picnic: temp > 15 && rain < 0.1 && uvIndex < 6 ? "IDEAL" : temp > 10 ? "PREVOIR PULL" : "TROP FROID",
                garden: rain < 0.1 && wind < 20 && temp > 5 ? "IDEAL" : "ATTENDRE",
                bbq: rain < 0.1 && wind < 15 ? "GO" : "REPORTER",
                car: rain < 0.1 ? "GO" : "ATTENDRE 2J",
                watering: rain > 2 ? "INUTILE" : temp > 25 || humidity < 40 ? "URGENT" : "OPTIONNEL",
                drying: rain < 0.1 && wind > 10 && humidity < 60 ? "PARFAIT" : rain < 0.1 ? "LENT" : "IMPOSSIBLE",
                hiking: hiking,
                camping: camping
            };
        }

        // Calculer les donn√©es d'humidit√© et de confort
        function calculateHumidityData(data) {
            const current = data.current;
            const temp = current.temperature_2m;
            const humidity = current.relative_humidity_2m;
            const rain = current.precipitation;

            // Sensation d'humidit√©
            let comfort = "";
            if (humidity < 30) {
                comfort = "TRES SEC";
            } else if (humidity < 40) {
                comfort = "SEC";
            } else if (humidity < 60) {
                comfort = "IDEAL";
            } else if (humidity < 70) {
                comfort = "HUMIDE";
            } else {
                comfort = "TRES HUMIDE";
            }

            // S√©choir int√©rieur avec temps de s√©chage
            let indoorDrying = "";
            if (rain > 0.1 || humidity > 80) {
                indoorDrying = "LENT (12H+)";
            } else if (temp < 10) {
                indoorDrying = "NORMAL (6-8H)";
            } else {
                indoorDrying = "RAPIDE (3-4H)";
            }

            // A√©ration maison
            let ventilate = "";
            if (humidity > 70) {
                ventilate = "URGENT - DESHUMIDIFIER";
            } else if (temp > 20 || humidity > 60) {
                ventilate = "RECOMMANDE";
            } else if (temp < 10) {
                ventilate = "NON - TROP FROID";
            } else {
                ventilate = "OPTIONNEL";
            }

            // Point de ros√©e (approximation)
            const dewPoint = temp - ((100 - humidity) / 5);

            // Risque de brouillard
            let fogRisk = "";
            const tempDewDiff = temp - dewPoint;
            if (tempDewDiff < 2) {
                fogRisk = "ELEVE";
            } else if (tempDewDiff < 5) {
                fogRisk = "MOYEN";
            } else {
                fogRisk = "FAIBLE";
            }

            return {
                humidity: Math.round(humidity),
                comfort: comfort,
                indoorDrying: indoorDrying,
                ventilate: ventilate,
                dewPoint: Math.round(dewPoint * 10) / 10,
                fogRisk: fogRisk
            };
        }

        // Autocompl√©tion des villes
        let searchTimeout;
        let selectedSuggestionIndex = -1;
        let suggestions = [];

        async function searchCities(query) {
            if (query.length < 2) return [];

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=8&countrycodes=fr,be,ch,lu,es,it,de,gb`
                );
                const results = await response.json();

                return results
                    .filter(result => result.type === 'administrative' || result.type === 'city' || result.class === 'place')
                    .map(result => ({
                        name: result.display_name.split(',')[0],
                        fullName: result.display_name,
                        lat: parseFloat(result.lat),
                        lon: parseFloat(result.lon),
                        country: result.display_name.split(',').pop().trim()
                    }))
                    .slice(0, 5);
            } catch (error) {
                console.error('Erreur recherche villes:', error);
                return [];
            }
        }

        function displaySuggestions(cityResults) {
            const suggestionsContainer = document.getElementById('city-suggestions');

            if (cityResults.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            suggestions = cityResults;
            selectedSuggestionIndex = -1;

            suggestionsContainer.innerHTML = cityResults
                .map((city, index) =>
                    `<div class="city-suggestion" data-index="${index}">
                        ${city.name}, ${city.country}
                    </div>`
                ).join('');

            suggestionsContainer.style.display = 'block';

            // Gestion des clics sur les suggestions
            suggestionsContainer.querySelectorAll('.city-suggestion').forEach((element, index) => {
                element.addEventListener('click', () => selectCity(suggestions[index]));
            });
        }

        function selectCity(city) {
            currentCity = {
                name: city.name.toUpperCase(),
                lat: city.lat,
                lon: city.lon
            };

            // Mettre √† jour l'interface
            document.getElementById('city-name').textContent = currentCity.name;
            document.getElementById('city-input').value = '';
            document.getElementById('city-suggestions').style.display = 'none';

            // Sauvegarder la pr√©f√©rence
            localStorage.setItem('preferred_city', JSON.stringify(currentCity));

            // Recharger les donn√©es m√©t√©o
            loadWeatherData(true);
        }

        // Syst√®me de cache pour limiter les appels API
        function getCachedData() {
            try {
                const cached = localStorage.getItem(getCacheKey());
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    const now = Date.now();
                    // V√©rifier si le cache est encore valide
                    if (now - timestamp < CACHE_DURATION) {
                        console.log('Utilisation du cache (valide pendant', Math.round((CACHE_DURATION - (now - timestamp)) / 1000), 'secondes)');
                        return data;
                    } else {
                        console.log('Cache expir√©, nouvelle requ√™te API');
                    }
                }
            } catch (error) {
                console.error('Erreur lecture cache:', error);
            }
            return null;
        }

        function setCachedData(data) {
            try {
                const cacheObject = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(getCacheKey(), JSON.stringify(cacheObject));
                console.log('Donn√©es mises en cache pour', currentCity.name);
            } catch (error) {
                console.error('Erreur √©criture cache:', error);
            }
        }

        async function loadWeatherData(forceRefresh = false) {
            try {
                let data = null;

                // Essayer de r√©cup√©rer depuis le cache sauf si forceRefresh est activ√©
                if (!forceRefresh) {
                    data = getCachedData();
                }

                // Si pas de donn√©es en cache ou forceRefresh, faire un appel API
                if (!data) {
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/forecast?latitude=${currentCity.lat}&longitude=${currentCity.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,cloud_cover,pressure_msl,wind_speed_10m,wind_direction_10m,wind_gusts_10m,uv_index,visibility&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,sunrise,sunset,uv_index_max,weather_code&hourly=temperature_2m,precipitation_probability,precipitation,wind_speed_10m,weather_code,is_day&timezone=Europe%2FParis&forecast_days=7`
                    );

                    if (!response.ok) {
                        throw new Error('Erreur chargement donn√©es');
                    }

                    data = await response.json();
                    // Mettre en cache les nouvelles donn√©es
                    setCachedData(data);
                }

                displayWeatherData(data);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('weather-content').style.display = 'block';

                // Afficher l'heure de derni√®re mise √† jour depuis les donn√©es
                const cacheInfo = getCachedData() ? ' (depuis cache)' : ' (nouvelles donn√©es)';
                document.getElementById('timestamp').textContent =
                    `DERNIERE MAJ: ${new Date().toLocaleString('fr-FR')}${cacheInfo}`;

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').innerHTML =
                    '<span style="color: #ff0000;">ERREUR CONNEXION SATELLITE - RETRY...</span>';
            }
        }

        function displayWeatherData(data) {
            const current = data.current;
            const daily = data.daily;

            // Temp√©rature
            document.getElementById('temp-current').textContent = `${Math.round(current.temperature_2m)}¬∞C`;
            document.getElementById('temp-feels').textContent = `${Math.round(current.apparent_temperature)}¬∞C`;
            document.getElementById('temp-minmax').textContent = `${Math.round(daily.temperature_2m_min[0])}¬∞C / ${Math.round(daily.temperature_2m_max[0])}¬∞C`;

            // Pr√©cipitations
            const rainProb = daily.precipitation_probability_max[0] || 0;
            document.getElementById('rain-prob').textContent = `${rainProb}%`;
            document.getElementById('rain-amount').textContent = current.precipitation > 0 ? `${current.precipitation.toFixed(1)} mm` : "< 0.1 mm";
            document.getElementById('umbrella-needed').textContent = rainProb > 70 ? "OUI" : "NON";

            // Vent
            document.getElementById('wind-speed').textContent = `${Math.round(current.wind_speed_10m)} km/h`;
            document.getElementById('wind-gusts').textContent = `${Math.round(current.wind_gusts_10m)} km/h`;
            document.getElementById('wind-direction').textContent = getWindDirection(current.wind_direction_10m);
            document.getElementById('wind-class').textContent = getWindClassification(current.wind_speed_10m);
            document.getElementById('wind-danger').textContent = current.wind_speed_10m > 50 ? "OUI" : "NON";

            // Visibilit√© et phares
            const visibility = current.visibility || 10000;
            const visibilityKm = (visibility / 1000).toFixed(1);
            document.getElementById('visibility').textContent = visibility > 1000 ? `${visibilityKm} km` : `${visibility} m`;
            document.getElementById('headlights').textContent = visibility < 1000 ? "OUI" : "NON";
            if (visibility < 1000) {
                document.getElementById('headlights').className = 'value warning';
            }

            // Indice UV
            const uvIndex = current.uv_index || 0;
            const uvMax = daily.uv_index_max ? daily.uv_index_max[0] : 0;
            document.getElementById('uv-index').textContent = `${uvIndex.toFixed(1)} (max: ${uvMax.toFixed(1)})`;
            document.getElementById('sunscreen').textContent = uvIndex > 2 ? "OUI" : "NON";
            if (uvIndex > 2) {
                document.getElementById('sunscreen').className = 'value warning';
            }

            // Heures soleil
            if (daily.sunrise && daily.sunset) {
                const sunrise = new Date(daily.sunrise[0]);
                const sunset = new Date(daily.sunset[0]);
                const now = new Date();

                document.getElementById('sunrise').textContent = sunrise.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('sunset').textContent = sunset.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                if (now < sunset && now > sunrise) {
                    const remaining = (sunset - now) / (1000 * 60 * 60);
                    const hours = Math.floor(remaining);
                    const minutes = Math.floor((remaining - hours) * 60);
                    document.getElementById('daylight-remaining').textContent = `${hours}h${minutes < 10 ? '0' : ''}${minutes}`;
                } else {
                    document.getElementById('daylight-remaining').textContent = "NUIT";
                }
            }

            // ASCII Art et description m√©t√©o
            const visualization = getWeatherVisualization(
                current.weather_code,
                current.is_day === 1,
                current.precipitation,
                current.cloud_cover,
                current.wind_speed_10m
            );
            document.getElementById('weather-icon').textContent = visualization.emoji;
            document.getElementById('weather-description').textContent = visualization.description;

            // Alertes m√©t√©o
            displayAlerts(data);

            // Pr√©visions horaires
            if (data.hourly) {
                displayHourlyForecast(data.hourly);
            }

            // Graphique pr√©visions 7 jours
            if (data.daily) {
                displayWeeklyForecast(data.daily);
            }

            // Donn√©es d'humidit√© et de confort
            const humidityData = calculateHumidityData(data);
            document.getElementById('humidity-current').textContent = `${humidityData.humidity}%`;
            document.getElementById('humidity-comfort').textContent = humidityData.comfort;
            document.getElementById('humidity-indoor-drying').textContent = humidityData.indoorDrying;
            document.getElementById('humidity-ventilate').textContent = humidityData.ventilate;
            document.getElementById('dew-point').textContent = `${humidityData.dewPoint}¬∞C`;
            document.getElementById('fog-risk').textContent = humidityData.fogRisk;

            // Activit√©s et conseils
            const activities = calculateActivities(data);
            document.getElementById('activity-school').textContent = activities.school;
            document.getElementById('activity-sport').textContent = activities.sport;
            document.getElementById('activity-picnic').textContent = activities.picnic;
            document.getElementById('activity-garden').textContent = activities.garden;
            document.getElementById('activity-bbq').textContent = activities.bbq;
            document.getElementById('activity-car').textContent = activities.car;
            document.getElementById('activity-watering').textContent = activities.watering;
            document.getElementById('activity-drying').textContent = activities.drying;
            document.getElementById('activity-hiking').textContent = activities.hiking;
            document.getElementById('activity-camping').textContent = activities.camping;

            // Colorer les √©l√©ments d'humidit√©
            const humidityElements = [
                { id: 'humidity-comfort', value: humidityData.comfort },
                { id: 'humidity-indoor-drying', value: humidityData.indoorDrying },
                { id: 'humidity-ventilate', value: humidityData.ventilate },
                { id: 'fog-risk', value: humidityData.fogRisk }
            ];

            humidityElements.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    if (item.value.includes('IDEAL') || item.value.includes('RAPIDE') || item.value.includes('FAIBLE') ||
                        item.value.includes('OPTIONNEL')) {
                        element.className = 'value status-ok';
                    } else if (item.value.includes('SEC') || item.value.includes('HUMIDE') || item.value.includes('NORMAL') ||
                               item.value.includes('RECOMMANDE') || item.value.includes('MOYEN')) {
                        element.className = 'value status-caution';
                    } else if (item.value.includes('TRES') || item.value.includes('LENT') || item.value.includes('URGENT') ||
                               item.value.includes('ELEVE') || item.value.includes('NON')) {
                        element.className = 'value status-bad';
                    } else {
                        element.className = 'value';
                    }
                }
            });

            // Colorer selon les r√©sultats des activit√©s
            ['school', 'sport', 'picnic', 'garden', 'bbq', 'car', 'watering', 'drying', 'hiking', 'camping'].forEach(activity => {
                const element = document.getElementById(`activity-${activity}`);
                if (element) {
                    const text = element.textContent;
                    if (text.includes('PARFAIT') || text.includes('IDEAL') || text.includes('GO') ||
                        text.includes('T-SHIRT') || text.includes('INUTILE')) {
                        element.className = 'status-ok';
                    } else if (text.includes('PREVOIR') || text.includes('ATTENDRE') || text.includes('DIFFICILE') ||
                               text.includes('OPTIONNEL') || text.includes('GILET') || text.includes('VESTE') ||
                               text.includes('ACCEPTABLE') || text.includes('CONDITIONS')) {
                        element.className = 'status-caution';
                    } else if (text.includes('MANTEAU') || text.includes('REPORTER') || text.includes('DANGEREUX') ||
                               text.includes('IMPOSSIBLE') || text.includes('URGENT') || text.includes('GEL')) {
                        element.className = 'status-bad';
                    }
                }
            });
        }


        // Gestion des √©v√©nements du champ de recherche
        document.addEventListener('DOMContentLoaded', () => {
            const cityInput = document.getElementById('city-input');
            const suggestionsContainer = document.getElementById('city-suggestions');

            // Charger la ville pr√©f√©r√©e au d√©marrage
            const preferredCity = localStorage.getItem('preferred_city');
            if (preferredCity) {
                currentCity = JSON.parse(preferredCity);
                document.getElementById('city-name').textContent = currentCity.name;
                document.getElementById('footer-city').textContent = currentCity.name;
                document.getElementById('footer-coords').textContent = `${currentCity.lat.toFixed(1)}¬∞N, ${currentCity.lon.toFixed(1)}¬∞E`;
            }

            // √âv√©nements du champ de saisie
            cityInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim();

                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    if (query.length >= 2) {
                        const cities = await searchCities(query);
                        displaySuggestions(cities);
                    } else {
                        suggestionsContainer.style.display = 'none';
                    }
                }, 300);
            });

            // Navigation au clavier
            cityInput.addEventListener('keydown', (e) => {
                if (suggestions.length === 0) return;

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                        updateSelectedSuggestion();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                        updateSelectedSuggestion();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0) {
                            selectCity(suggestions[selectedSuggestionIndex]);
                        }
                        break;
                    case 'Escape':
                        suggestionsContainer.style.display = 'none';
                        cityInput.blur();
                        break;
                }
            });

            // Fermer les suggestions en cliquant ailleurs
            document.addEventListener('click', (e) => {
                if (!cityInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });

            function updateSelectedSuggestion() {
                const suggestionElements = suggestionsContainer.querySelectorAll('.city-suggestion');
                suggestionElements.forEach((el, index) => {
                    el.classList.toggle('selected', index === selectedSuggestionIndex);
                });
            }

            // Mettre √† jour le footer avec les coordonn√©es actuelles
            function updateFooter() {
                document.getElementById('footer-city').textContent = currentCity.name;
                document.getElementById('footer-coords').textContent = `${currentCity.lat.toFixed(1)}¬∞N, ${currentCity.lon.toFixed(1)}¬∞E`;
            }

            // Charger les donn√©es au d√©marrage
            loadWeatherData();
            updateFooter();

            // Actualiser toutes les 10 minutes (force le rafra√Æchissement depuis l'API)
            setInterval(() => loadWeatherData(true), 600000);
        });
    </script>
</body>
</html>