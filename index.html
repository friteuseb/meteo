<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©t√©o Amiens - Temps r√©el</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
     <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå§Ô∏è</text></svg>">

     <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F1Z1EG4HZS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-F1Z1EG4HZS');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            line-height: 1.4;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border: double 3px #00ff00;
            padding: 15px;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 12px;
            color: #ffff00;
        }

        .timestamp {
            color: #888;
            margin-top: 10px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .panel {
            border: solid 1px #00ff00;
            padding: 20px;
            background: rgba(0, 255, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .data-line {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .label {
            color: #ccc;
        }

        .value {
            color: #00ff00;
            font-weight: bold;
        }

        .value.warning {
            color: #ffff00;
        }

        .value.danger {
            color: #ff0000;
        }

        .weather-visual {
            margin: 30px 0;
            border: double 3px #00ff00;
            padding: 20px;
            text-align: center;
        }

        .visual-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .weather-icon {
            font-size: 4em;
            line-height: 1.2;
            margin: 20px auto;
            text-align: center;
        }

        .weather-description {
            color: #ffff00;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
        }

        .alerts-section {
            margin: 20px 0;
            border: solid 2px #ff0000;
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
        }

        .alert-title {
            color: #ff0000;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .alerts-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .alert-item {
            color: #ffff00;
            padding: 5px;
            border-left: 3px solid #ff0000;
            padding-left: 10px;
        }

        .sun-info {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #333;
            background: rgba(255, 255, 0, 0.05);
        }

        .sun-item {
            text-align: center;
        }

        .sun-label {
            color: #888;
            font-size: 12px;
        }

        .sun-value {
            color: #ffff00;
            font-weight: bold;
            font-size: 16px;
        }

        .forecast-section {
            margin: 30px 0;
            padding: 20px;
            border: double 3px #00ff00;
            background: rgba(0, 255, 0, 0.02);
        }

        .forecast-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }

        .forecast-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            font-family: 'Roboto Mono', 'Courier New', monospace;
            color: #00ff00;
        }

        .forecast-day {
            border: 1px solid #333;
            padding: 15px 5px;
            text-align: center;
            background: rgba(0, 255, 0, 0.01);
        }

        .forecast-day.today {
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.05);
        }

        .forecast-day-name {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .forecast-icon {
            font-size: 32px;
            margin: 10px 0;
            line-height: 1;
        }

        .forecast-temps {
            margin: 10px 0;
            font-size: 14px;
        }

        .temp-max {
            color: #ff6666;
            font-weight: bold;
        }

        .temp-min {
            color: #6666ff;
        }

        .forecast-rain {
            color: #00ffff;
            font-size: 12px;
            margin-top: 5px;
        }

        .forecast-summary {
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #333;
            text-align: center;
            color: #ffff00;
        }

        .hourly-forecast {
            margin: 30px 0;
            padding: 20px;
            border: double 3px #00ff00;
            background: rgba(0, 255, 0, 0.02);
        }

        .hourly-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }

        .hourly-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .hourly-item {
            border: 1px solid #333;
            padding: 15px 10px;
            text-align: center;
            background: rgba(0, 255, 0, 0.01);
        }

        .hourly-item.current {
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.05);
        }

        .hourly-period {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .hourly-time {
            color: #888;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .hourly-icon {
            font-size: 28px;
            margin: 10px 0;
            line-height: 1;
        }

        .hourly-temp {
            color: #00ff00;
            font-weight: bold;
            font-size: 16px;
            margin: 5px 0;
        }

        .hourly-rain {
            color: #00ffff;
            font-size: 12px;
            margin-top: 5px;
        }

        .hourly-wind {
            color: #888;
            font-size: 11px;
            margin-top: 3px;
        }

        @media (max-width: 900px) {
            .forecast-container {
                grid-template-columns: repeat(4, 1fr);
            }
            .hourly-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .forecast-container {
                grid-template-columns: repeat(2, 1fr);
            }
            .hourly-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .activity-section {
            margin: 30px 0;
            border: solid 1px #888;
            padding: 20px;
        }

        .activity-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #333;
            background: rgba(0, 255, 0, 0.02);
        }

        .status-ok { color: #00ff00; }
        .status-caution { color: #ffff00; }
        .status-bad { color: #ff0000; }

        .footer {
            margin-top: 40px;
            text-align: center;
            color: #666;
            border-top: 1px solid #333;
            padding-top: 20px;
        }

        .ascii-art {
            color: #888;
            font-size: 10px;
            text-align: center;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre;
            line-height: 1.2;
        }

        .loading {
            color: #ffff00;
            text-align: center;
            margin: 20px 0;
        }

        .city-selector {
            position: relative;
            display: inline-block;
            margin-left: 20px;
        }

        .city-input {
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 5px 10px;
            font-family: inherit;
            font-size: 11px;
            width: 200px;
            outline: none;
        }

        .city-input::placeholder {
            color: #666;
        }

        .city-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #000;
            border: 1px solid #00ff00;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .city-suggestion {
            padding: 8px 10px;
            cursor: pointer;
            color: #00ff00;
            font-size: 11px;
            border-bottom: 1px solid #333;
        }

        .city-suggestion:hover,
        .city-suggestion.selected {
            background: rgba(0, 255, 0, 0.1);
        }

        .city-suggestion:last-child {
            border-bottom: none;
        }

        /* Mode Simplifi√© - Style app mobile */
        .simplified-mode .container {
            max-width: 600px;
        }

        .simplified-mode .header {
            text-align: center;
            padding: 20px;
        }

        .simplified-mode .title {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .simplified-mode .subtitle {
            font-size: 16px;
        }

        .simplified-mode .timestamp {
            font-size: 14px;
            margin: 15px 0;
        }

        .simplified-mode .weather-visual {
            text-align: center;
            padding: 30px 20px;
            margin: 20px 0;
        }

        .simplified-mode .weather-icon {
            font-size: 6em;
            margin: 20px 0;
        }

        .simplified-mode .weather-description {
            font-size: 24px;
            margin: 20px 0;
        }

        .simplified-mode .current-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
            text-align: center;
        }

        .simplified-mode .summary-item {
            padding: 20px;
            border: 2px solid #00ff00;
            background: rgba(0, 255, 0, 0.05);
        }

        .simplified-mode .summary-label {
            color: #888;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .simplified-mode .summary-value {
            color: #00ff00;
            font-size: 28px;
            font-weight: bold;
        }

        .simplified-mode .forecast-section {
            margin: 30px 0;
        }

        .simplified-mode .forecast-title {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .simplified-mode .forecast-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }

        .simplified-mode .forecast-day {
            border: 2px solid #00ff00;
            padding: 20px 10px;
            background: rgba(0, 255, 0, 0.05);
        }

        .simplified-mode .forecast-day.today {
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.1);
        }

        .simplified-mode .forecast-day-name {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .simplified-mode .forecast-icon {
            font-size: 48px;
            margin: 15px 0;
        }

        .simplified-mode .forecast-temps {
            font-size: 20px;
            margin: 15px 0;
        }

        .simplified-mode .temp-max {
            color: #ff6666;
            font-weight: bold;
        }

        .simplified-mode .temp-min {
            color: #6666ff;
        }

        .simplified-mode .forecast-rain {
            font-size: 16px;
            margin-top: 10px;
        }

        /* Masquer les sections avanc√©es en mode simple */
        .simplified-mode .main-grid,
        .simplified-mode .hourly-forecast,
        .simplified-mode .activity-section,
        .simplified-mode .panel {
            display: none !important;
        }

        /* Afficher seulement les sections simplifi√©es */
        .simplified-mode .current-summary,
        .simplified-mode .forecast-section {
            display: block !important;
        }

        /* Mode Agriculteur */
        .farmer-mode {
            background: linear-gradient(135deg, #2d4a22 0%, #1a2e16 100%);
            color: #d4e4bc;
        }

        .farmer-mode .header {
            border-color: #8b7355;
            background: rgba(139, 115, 85, 0.1);
        }

        .farmer-mode .title {
            color: #d4e4bc;
        }

        .farmer-mode .subtitle {
            color: #a8c66c;
        }

        .farmer-mode .panel {
            border-color: #8b7355;
            background: rgba(139, 115, 85, 0.05);
        }

        .farmer-mode .panel-title {
            color: #a8c66c;
            border-bottom-color: #666;
        }

        .farmer-mode .value {
            color: #d4e4bc;
        }

        .farmer-mode .label {
            color: #b8c994;
        }

        .farmer-mode .weather-visual {
            border-color: #8b7355;
            background: rgba(139, 115, 85, 0.02);
        }

        .farmer-mode .forecast-section {
            border-color: #8b7355;
            background: rgba(139, 115, 85, 0.02);
        }

        .farmer-mode .forecast-title {
            color: #a8c66c;
        }

        .farmer-mode .forecast-day.today {
            border-color: #a8c66c;
            background: rgba(168, 198, 108, 0.1);
        }

        .farmer-mode .forecast-day-name {
            color: #a8c66c;
        }

        .farmer-mode .hourly-forecast {
            border-color: #8b7355;
            background: rgba(139, 115, 85, 0.02);
        }

        .farmer-mode .hourly-title {
            color: #a8c66c;
        }

        .farmer-mode .hourly-item.current {
            border-color: #a8c66c;
            background: rgba(168, 198, 108, 0.05);
        }

        .farmer-mode .alerts-section {
            border-color: #cc4444;
            background: rgba(204, 68, 68, 0.1);
        }

        .farmer-mode .alert-title {
            color: #ff6666;
        }

        .farmer-mode .activity-section {
            border-color: #666;
        }

        .farmer-mode .activity-title {
            color: #a8c66c;
        }

        /* Styles sp√©cifiques au mode agriculteur */
        .farmer-section {
            margin: 30px 0;
        }

        .farmer-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .farmer-panel {
            border: solid 1px #8b7355;
            padding: 20px;
            background: rgba(139, 115, 85, 0.05);
            display: flex;
            flex-direction: column;
        }

        .farmer-alerts {
            margin-bottom: 30px;
            border: solid 2px #cc4444;
            padding: 15px;
            background: rgba(204, 68, 68, 0.1);
        }

        .farmer-diseases {
            margin: 30px 0;
            border: solid 1px #666;
            padding: 20px;
        }

        .farmer-diseases-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .disease-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #333;
            background: rgba(139, 115, 85, 0.02);
        }

        .farmer-calendar {
            margin: 30px 0;
            border: solid 1px #666;
            padding: 20px;
        }

        .farmer-calendar-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .calendar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #333;
            background: rgba(139, 115, 85, 0.02);
        }

        /* Masquer les sections normales en mode agriculteur */
        .farmer-mode .main-grid,
        .farmer-mode .hourly-forecast,
        .farmer-mode .activity-section,
        .farmer-mode .current-summary,
        .farmer-mode .forecast-section {
            display: none !important;
        }

        /* Afficher seulement les sections agriculteurs */
        .farmer-mode .farmer-section {
            display: block !important;
        }

        /* Couleurs sp√©cifiques agriculteur */
        .farmer-mode .status-frost-high { color: #ff4444; }
        .farmer-mode .status-frost-medium { color: #ffaa44; }
        .farmer-mode .status-frost-low { color: #44ff44; }

        .farmer-mode .status-water-high { color: #4488ff; }
        .farmer-mode .status-water-medium { color: #44ff44; }
        .farmer-mode .status-water-low { color: #ffaa44; }

        .farmer-mode .status-disease-high { color: #ff4444; }
        .farmer-mode .status-disease-medium { color: #ffaa44; }
        .farmer-mode .status-disease-low { color: #44ff44; }

        /* Styles sp√©cifiques p√©pini√®re */
        .nursery-section {
            margin: 30px 0;
            border: solid 1px #666;
            padding: 20px;
            background: rgba(139, 115, 85, 0.02);
        }

        .nursery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .nursery-panel {
            border: solid 1px #6b8e23;
            padding: 20px;
            background: rgba(107, 142, 35, 0.05);
            display: flex;
            flex-direction: column;
        }

        .nursery-panel .panel-title {
            color: #6b8e23;
            border-bottom-color: #666;
        }

        .nursery-calendar {
            margin: 30px 0;
            border: solid 1px #666;
            padding: 20px;
        }

        .nursery-calendar-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        /* Couleurs sp√©cifiques p√©pini√®re */
        .farmer-mode .status-young-frost-high { color: #ff2222; }
        .farmer-mode .status-young-frost-medium { color: #ff8844; }
        .farmer-mode .status-young-frost-low { color: #66ff66; }

        .farmer-mode .status-fruit-disease-high { color: #ff2222; }
        .farmer-mode .status-fruit-disease-medium { color: #ff8844; }
        .farmer-mode .status-fruit-disease-low { color: #66ff66; }

        .farmer-mode .status-flowering-good { color: #66ff66; }
        .farmer-mode .status-flowering-caution { color: #ffaa44; }
        .farmer-mode .status-flowering-bad { color: #ff4444; }

        @media (max-width: 768px) {
            body {
                font-size: 12px;
                padding: 10px;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .activity-grid {
                grid-template-columns: 1fr;
            }

            .simplified-mode .forecast-container {
                grid-template-columns: 1fr;
            }

            .simplified-mode .current-summary {
                grid-template-columns: 1fr;
            }

            .farmer-grid {
                grid-template-columns: 1fr;
            }

            .farmer-diseases-grid {
                grid-template-columns: 1fr;
            }

            .farmer-calendar-grid {
                grid-template-columns: 1fr;
            }

            .nursery-grid {
                grid-template-columns: 1fr;
            }

            .nursery-calendar-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">‚ïê‚ïê‚ïê METEO DU BON SENS ‚ïê‚ïê‚ïê
                <div class="city-selector">
                    <input type="text" class="city-input" id="city-input" placeholder="Changer de ville...">
                    <div class="city-suggestions" id="city-suggestions"></div>
                </div>
            </div>
            <div class="city-display" id="city-display" style="color: #ffff00; font-size: 12px; margin: 5px 0; text-align: center;">Ville: AMIENS</div>
            <div class="subtitle">Donn√©es en temps r√©el</div>
            <div class="timestamp" id="timestamp">DERNIERE MAJ: --</div>
             <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                 <button onclick="setMode('advanced')" id="mode-advanced" style="background: transparent; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; cursor: pointer; font-family: inherit; font-size: 11px;">MODE AVANC√â</button>
                 <button onclick="setMode('simplified')" id="mode-simple" style="background: transparent; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; cursor: pointer; font-family: inherit; font-size: 11px;">MODE SIMPLE</button>
                 <button onclick="setMode('farmer')" id="mode-farmer" style="background: transparent; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; cursor: pointer; font-family: inherit; font-size: 11px;">MODE AGRICULTEUR</button>
                 <button onclick="loadWeatherData(true)" style="background: transparent; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; cursor: pointer; font-family: inherit; font-size: 11px;">‚Üª RAFRAICHIR</button>
             </div>
        </div>

        <div class="loading" id="loading">
            CHARGEMENT DES DONNEES SATELLITAIRES...
            [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 100%
        </div>

        <div id="weather-content" style="display: none;">
            <div class="weather-visual">
                <div class="visual-title">[ CONDITIONS ACTUELLES ]</div>
                <div class="weather-icon" id="weather-icon">
                    <!-- Emoji m√©t√©o sera ins√©r√© ici par JavaScript -->
                </div>
                <div class="weather-description" id="weather-description">
                    <!-- Description sera ins√©r√©e ici -->
                </div>
                <div class="sun-info">
                    <div class="sun-item">
                        <div class="sun-label">LEVER</div>
                        <div class="sun-value" id="sunrise">--:--</div>
                    </div>
                    <div class="sun-item">
                        <div class="sun-label">COUCHER</div>
                        <div class="sun-value" id="sunset">--:--</div>
                    </div>
                    <div class="sun-item">
                        <div class="sun-label">LUMIERE RESTANTE</div>
                        <div class="sun-value" id="daylight-remaining">--h--</div>
                    </div>
                </div>
            </div>

            <!-- R√©sum√© simplifi√© pour le mode simple -->
            <div class="current-summary" id="current-summary" style="display: none;">
                <div class="summary-item">
                    <div class="summary-label">TEMP√âRATURE</div>
                    <div class="summary-value" id="simple-temp">--¬∞C</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">PR√âCIPITATIONS</div>
                    <div class="summary-value" id="simple-rain">--%</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">VENT</div>
                    <div class="summary-value" id="simple-wind">-- km/h</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">VISIBILIT√â</div>
                    <div class="summary-value" id="simple-visibility">-- km</div>
                </div>
            </div>

            <div class="hourly-forecast">
                <div class="hourly-title">[ PREVISIONS PROCHAINES HEURES ]</div>
                <div class="hourly-container" id="hourly-container">
                    <!-- Pr√©visions horaires seront ins√©r√©es ici -->
                </div>
            </div>

            <div class="alerts-section" id="alerts-section" style="display: none;">
                <div class="alert-title">[ ALERTES ]</div>
                <div class="alerts-grid" id="alerts-grid">
                    <!-- Alertes dynamiques -->
                </div>
            </div>

            <div class="main-grid">
                <div class="panel">
                    <div class="panel-title">[ TEMPERATURE ]</div>
                    <div class="data-line">
                        <span class="label">ACTUELLE:</span>
                        <span class="value" id="temp-current">--¬∞C</span>
                    </div>
                    <div class="data-line">
                        <span class="label">RESSENTIE:</span>
                        <span class="value" id="temp-feels">--¬∞C</span>
                    </div>
                    <div class="data-line">
                        <span class="label">MIN/MAX:</span>
                        <span class="value" id="temp-minmax">--¬∞C / --¬∞C</span>
                    </div>
                    <div class="data-line">
                        <span class="label">TENDANCE 3H:</span>
                        <span class="value" id="temp-trend">STABLE</span>
                    </div>
                    <div class="data-line">
                        <span class="label">NORMAL SAISON:</span>
                        <span class="value" id="temp-normal">OUI</span>
                    </div>
                    <div class="data-line">
                        <span class="label">INDICE UV:</span>
                        <span class="value" id="uv-index">--</span>
                    </div>
                    <div class="data-line">
                        <span class="label">CREME SOLAIRE:</span>
                        <span class="value" id="sunscreen">NON</span>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">[ PRECIPITATIONS ]</div>
                    <div class="data-line">
                        <span class="label">PROBABILITE:</span>
                        <span class="value" id="rain-prob">--%</span>
                    </div>
                    <div class="data-line">
                        <span class="label">QUANTITE SI PLUIE:</span>
                        <span class="value" id="rain-amount">-- mm</span>
                    </div>
                    <div class="data-line">
                        <span class="label">DERNIERE PLUIE:</span>
                        <span class="value" id="last-rain">-- JOURS</span>
                    </div>
                    <div class="data-line">
                        <span class="label">CUMUL SEMAINE:</span>
                        <span class="value" id="week-rain">-- mm</span>
                    </div>
                    <div class="data-line">
                        <span class="label">PARAPLUIE REQUIS:</span>
                        <span class="value" id="umbrella-needed">NON</span>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">[ VENT & VISIBILITE ]</div>
                    <div class="data-line">
                        <span class="label">VITESSE MOYENNE:</span>
                        <span class="value" id="wind-speed">-- km/h</span>
                    </div>
                    <div class="data-line">
                        <span class="label">RAFALES MAX:</span>
                        <span class="value" id="wind-gusts">-- km/h</span>
                    </div>
                    <div class="data-line">
                        <span class="label">DIRECTION:</span>
                        <span class="value" id="wind-direction">--</span>
                    </div>
                    <div class="data-line">
                        <span class="label">CLASSIFICATION:</span>
                        <span class="value" id="wind-class">BRISE LEGERE</span>
                    </div>
                    <div class="data-line">
                        <span class="label">DANGEREUX:</span>
                        <span class="value" id="wind-danger">NON</span>
                    </div>
                    <div class="data-line">
                        <span class="label">VISIBILITE:</span>
                        <span class="value" id="visibility">-- km</span>
                    </div>
                    <div class="data-line">
                        <span class="label">PHARES REQUIS:</span>
                        <span class="value" id="headlights">NON</span>
                    </div>
                </div>
            </div>

            <div class="forecast-section">
                <div class="forecast-title">[ PREVISIONS 7 JOURS ]</div>
                <div class="forecast-container" id="forecast-container">
                    <!-- Pr√©visions 7 jours seront ins√©r√©es ici -->
                </div>
                <div class="forecast-summary" id="forecast-summary">
                    <!-- R√©sum√© des pr√©visions -->
                </div>
            </div>

            <div class="panel" style="margin: 30px auto; max-width: 600px;">
                <div class="panel-title">[ HUMIDITE & CONFORT ]</div>
                <div class="data-line">
                    <span class="label">HUMIDITE:</span>
                    <span class="value" id="humidity-current">--%</span>
                </div>
                <div class="data-line">
                    <span class="label">SENSATION:</span>
                    <span class="value" id="humidity-comfort">--</span>
                </div>
                <div class="data-line">
                    <span class="label">SECHOIR INTERIEUR:</span>
                    <span class="value" id="humidity-indoor-drying">--</span>
                </div>
                <div class="data-line">
                    <span class="label">AERER MAISON:</span>
                    <span class="value" id="humidity-ventilate">--</span>
                </div>
                <div class="data-line">
                    <span class="label">POINT DE ROSEE:</span>
                    <span class="value" id="dew-point">--¬∞C</span>
                </div>
                <div class="data-line">
                    <span class="label">RISQUE BROUILLARD:</span>
                    <span class="value" id="fog-risk">--</span>
                </div>
            </div>

             <div class="activity-section">
                 <div class="activity-title">[ CONSEILS DU JOUR ]</div>
                 <div class="activity-grid">
                     <div class="activity-item">
                         <span>TENUE ECOLE:</span>
                         <span class="status-ok" id="activity-school">T-SHIRT</span>
                     </div>
                     <div class="activity-item">
                         <span>VELO/FOOTING:</span>
                         <span class="status-ok" id="activity-sport">PARFAIT</span>
                     </div>
                     <div class="activity-item">
                         <span>PIQUE-NIQUE:</span>
                         <span class="status-caution" id="activity-picnic">PREVOIR PULL</span>
                     </div>
                     <div class="activity-item">
                         <span>BARBECUE:</span>
                         <span class="status-ok" id="activity-bbq">GO</span>
                     </div>
                     <div class="activity-item">
                         <span>JARDINAGE:</span>
                         <span class="status-ok" id="activity-garden">IDEAL</span>
                     </div>
                     <div class="activity-item">
                         <span>ARROSER JARDIN:</span>
                         <span class="status-caution" id="activity-watering">NON</span>
                     </div>
                     <div class="activity-item">
                         <span>SECHER LINGE DEHORS:</span>
                         <span class="status-ok" id="activity-drying">PARFAIT</span>
                     </div>
                     <div class="activity-item">
                         <span>RANDONNEE:</span>
                         <span class="status-ok" id="activity-hiking">IDEAL</span>
                     </div>
                     <div class="activity-item">
                         <span>BIVOUAC:</span>
                         <span class="status-caution" id="activity-camping">PREVOIR CHAUD</span>
                     </div>
                     <div class="activity-item">
                         <span>LAVER VOITURE:</span>
                         <span class="status-caution" id="activity-car">ATTENDRE 2J</span>
                     </div>
                 </div>
             </div>

             <!-- Section Agriculteur -->
             <div class="farmer-section" id="farmer-section" style="display: none;">
                 <div class="farmer-alerts" id="farmer-alerts" style="display: none;">
                     <div class="alert-title">[ ALERTES AGRICOLES ]</div>
                     <div class="alerts-grid" id="farmer-alerts-grid">
                         <!-- Alertes agricoles dynamiques -->
                     </div>
                 </div>

                 <div class="farmer-grid">
                     <div class="farmer-panel">
                         <div class="panel-title">[ GEL & PROTECTION ]</div>
                         <div class="data-line">
                             <span class="label">RISQUE GEL AUJOURD'HUI:</span>
                             <span class="value" id="frost-risk-today">FAIBLE</span>
                         </div>
                         <div class="data-line">
                             <span class="label">TEMP MIN PROCHAINES NUITS:</span>
                             <span class="value" id="frost-next-nights">--¬∞C</span>
                         </div>
                         <div class="data-line">
                             <span class="label">PROTECTION RECOMMANDEE:</span>
                             <span class="value" id="frost-protection">AUCUNE</span>
                         </div>
                         <div class="data-line">
                             <span class="label">JOURS SANS GEL:</span>
                             <span class="value" id="frost-free-days">--</span>
                         </div>
                     </div>

                     <div class="farmer-panel">
                         <div class="panel-title">[ IRRIGATION & EAU ]</div>
                         <div class="data-line">
                             <span class="label">BESOINS IRRIGATION:</span>
                             <span class="value" id="irrigation-needs">MODERES</span>
                         </div>
                         <div class="data-line">
                             <span class="label">PLUIE RECENTE (7J):</span>
                             <span class="value" id="recent-rain">-- mm</span>
                         </div>
                         <div class="data-line">
                             <span class="label">EVAPORATION ESTIMEE:</span>
                             <span class="value" id="evaporation">-- mm/jour</span>
                         </div>
                         <div class="data-line">
                             <span class="label">STRESS HYDRIQUE:</span>
                             <span class="value" id="water-stress">FAIBLE</span>
                         </div>
                     </div>

                     <div class="farmer-panel">
                         <div class="panel-title">[ TRAITEMENTS PHYTOS ]</div>
                         <div class="data-line">
                             <span class="label">CONDITIONS PULVERISATION:</span>
                             <span class="value" id="spraying-conditions">FAVORABLES</span>
                         </div>
                         <div class="data-line">
                             <span class="label">VENT POUR TRAITEMENTS:</span>
                             <span class="value" id="treatment-wind">OK</span>
                         </div>
                         <div class="data-line">
                             <span class="label">PLUIE DANS 24H:</span>
                             <span class="value" id="rain-24h">-- mm</span>
                         </div>
                         <div class="data-line">
                             <span class="label">FENETRE TRAITEMENT:</span>
                             <span class="value" id="treatment-window">-- heures</span>
                         </div>
                     </div>
                 </div>

                 <div class="farmer-diseases">
                     <div class="panel-title">[ MALADIES & PARASITES ]</div>
                     <div class="farmer-diseases-grid">
                         <div class="disease-item">
                             <span>RISQUE MILDOUT:</span>
                             <span class="value" id="mildew-risk">FAIBLE</span>
                         </div>
                         <div class="disease-item">
                             <span>RISQUE OIDUM:</span>
                             <span class="value" id="powdery-mildew-risk">FAIBLE</span>
                         </div>
                         <div class="disease-item">
                             <span>CONDITIONS FONGIQUES:</span>
                             <span class="value" id="fungal-conditions">DEFAVORABLES</span>
                         </div>
                         <div class="disease-item">
                             <span>ACTIVITE PARASITES:</span>
                             <span class="value" id="pest-activity">FAIBLE</span>
                         </div>
                     </div>
                 </div>

                 <div class="farmer-calendar">
                     <div class="panel-title">[ CALENDRIER AGRICOLE ]</div>
                     <div class="farmer-calendar-grid">
                         <div class="calendar-item">
                             <span>JOURS OPTIMAUX SEMIS:</span>
                             <span class="value" id="optimal-seeding">--</span>
                         </div>
                         <div class="calendar-item">
                             <span>FENETRE RECOLTE:</span>
                             <span class="value" id="harvest-window">-- jours</span>
                         </div>
                         <div class="calendar-item">
                             <span>TRAVAIL SOL POSSIBLE:</span>
                             <span class="value" id="soil-work">OUI</span>
                         </div>
                         <div class="calendar-item">
                             <span>SECHAGE RECOLTES:</span>
                             <span class="value" id="drying-conditions">FAVORABLES</span>
                         </div>
                     </div>
                 </div>

                 <!-- Section P√©pini√©riste -->
                 <div class="nursery-section">
                     <div class="panel-title">[ P√âPINI√àRE - ARBRES FRUITIERS ]</div>

                     <div class="nursery-grid">
                         <div class="nursery-panel">
                             <div class="panel-title">[ PROTECTION JEUNES PLANTS ]</div>
                             <div class="data-line">
                                 <span class="label">RISQUE GEL ARBRES 1-2 ANS:</span>
                                 <span class="value" id="young-tree-frost">FAIBLE</span>
                             </div>
                             <div class="data-line">
                                 <span class="label">PROTECTION HIVERNALE:</span>
                                 <span class="value" id="winter-protection">PAILLIS</span>
                             </div>
                             <div class="data-line">
                                 <span class="label">ARROSAGE HIVERNAL:</span>
                                 <span class="value" id="winter-watering">MODERE</span>
                             </div>
                             <div class="data-line">
                                 <span class="label">TAILLE HIVERNALE:</span>
                                 <span class="value" id="winter-pruning">POSSIBLE</span>
                             </div>
                         </div>

                         <div class="nursery-panel">
                             <div class="panel-title">[ MALADIES FRUITIERS ]</div>
                             <div class="data-line">
                                 <span class="label">RISQUE TAVELURE:</span>
                                 <span class="value" id="scab-risk">FAIBLE</span>
                             </div>
                             <div class="data-line">
                                 <span class="label">RISQUE MONILIOSE:</span>
                                 <span class="value" id="monilinia-risk">FAIBLE</span>
                             </div>
                             <div class="data-line">
                                 <span class="label">RISQUE OIDIUM FRUITIERS:</span>
                                 <span class="value" id="fruit-powdery-mildew">FAIBLE</span>
                             </div>
                             <div class="data-line">
                                 <span class="label">TRAITEMENT PREVENTIF:</span>
                                 <span class="value" id="preventive-treatment">NON</span>
                             </div>
                         </div>

                         <div class="nursery-panel">
                             <div class="panel-title">[ FLORAISON & POLLINISATION ]</div>
                             <div class="data-line">
                                 <span class="label">CONDITIONS FLORAISON:</span>
                                 <span class="value" id="flowering-conditions">FAVORABLES</span>
                             </div>
                             <div class="data-line">
                                 <span class="label">RISQUE GEL FLORAISON:</span>
                                 <span class="value" id="flowering-frost-risk">AUCUN</span>
                             </div>
                             <div class="data-line">
                                 <span class="label">ACTIVITE ABEILLES:</span>
                                 <span class="value" id="bee-activity">MODEREE</span>
                             </div>
                             <div class="data-line">
                                 <span class="label">FENETRE POLLINISATION:</span>
                                 <span class="value" id="pollination-window">-- jours</span>
                             </div>
                         </div>
                     </div>

                     <div class="nursery-calendar">
                         <div class="panel-title">[ CALENDRIER P√âPINI√àRE ]</div>
                         <div class="nursery-calendar-grid">
                             <div class="calendar-item">
                                 <span>PLANTATION PRINTEMPS:</span>
                                 <span class="value" id="spring-planting">ATTENDRE</span>
                             </div>
                             <div class="calendar-item">
                                 <span>TAILLE ETE:</span>
                                 <span class="value" id="summer-pruning">POSSIBLE</span>
                             </div>
                             <div class="calendar-item">
                                 <span>RECOLTE FRUITS:</span>
                                 <span class="value" id="fruit-harvest">--</span>
                             </div>
                             <div class="calendar-item">
                                 <span>PREPARATION HIVER:</span>
                                 <span class="value" id="winter-prep">EN COURS</span>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>

            <div class="ascii-art">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               M√©t√©o locale sans exag√©ration                ‚îÇ
‚îÇ               Donn√©es Open-Meteo.com fiables               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</div>
        </div>

        <div class="footer">
            <div>Station <span id="footer-city">Amiens</span> - Coordonn√©es: <span id="footer-coords">49.9¬∞N, 2.3¬∞E</span></div>
            <div>Source: Open-Meteo.com | Mise √† jour: 10 minutes</div>
        </div>
    </div>

    <script>
        // Configuration g√©ographique dynamique
        let currentCity = {
            name: "AMIENS",
            lat: 49.9,
            lon: 2.3
        };

        // Mode d'affichage
        let currentMode = 'advanced'; // 'advanced', 'simplified', 'farmer'

        // Syst√®me de cache par ville
        const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes en millisecondes

        function getCacheKey() {
            return `meteo_${currentCity.name.toLowerCase()}_cache`;
        }


        // Classification des vents selon √©chelle de Beaufort
        function getWindClassification(speed) {
            if (speed < 6) return "CALME";
            if (speed < 12) return "BRISE LEGERE";
            if (speed < 20) return "BRISE MODEREE";
            if (speed < 29) return "BONNE BRISE";
            if (speed < 39) return "VENT FRAIS";
            if (speed < 50) return "VENT FORT";
            return "TEMPETE";
        }

        // Direction du vent en texte
        function getWindDirection(degrees) {
            const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSO", "SO", "OSO", "O", "ONO", "NO", "NNO"];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        // D√©terminer l'emoji et la description selon le code m√©t√©o
        function getWeatherVisualization(weatherCode, isDay, precipitation, cloudCover, windSpeed) {
            let emoji = "";
            let description = "";

            // Codes m√©t√©o WMO
            // 0: Clear sky
            // 1, 2, 3: Mainly clear, partly cloudy, and overcast
            // 45, 48: Fog and depositing rime fog
            // 51, 53, 55: Drizzle: Light, moderate, and dense intensity
            // 61, 63, 65: Rain: Slight, moderate and heavy intensity
            // 71, 73, 75: Snow fall: Slight, moderate, and heavy intensity
            // 80, 81, 82: Rain showers: Slight, moderate, and violent
            // 95: Thunderstorm: Slight or moderate
            // 96, 99: Thunderstorm with slight and heavy hail

            if (!isDay) {
                emoji = "üåô";
                description = "NUIT ";
            }

            switch(weatherCode) {
                case 0:
                    if (isDay) {
                        emoji = "‚òÄÔ∏è";
                        description = "ENSOLEILLE";
                    } else {
                        description += "CLAIRE";
                    }
                    break;
                case 1:
                case 2:
                    if (isDay) {
                        emoji = "üå§Ô∏è";
                        description = "PARTIELLEMENT NUAGEUX";
                    } else {
                        description += "PARTIELLEMENT NUAGEUSE";
                    }
                    break;
                case 3:
                    emoji = "‚òÅÔ∏è";
                    description = isDay ? "NUAGEUX" : description + "NUAGEUSE";
                    break;
                case 45:
                case 48:
                    emoji = "üå´Ô∏è";
                    description = "BROUILLARD";
                    break;
                case 51:
                case 53:
                case 55:
                    emoji = "üå¶Ô∏è";
                    description = "BRUINE";
                    break;
                case 61:
                case 63:
                case 65:
                    emoji = "üåßÔ∏è";
                    description = weatherCode === 65 ? "FORTE PLUIE" : "PLUIE";
                    break;
                case 71:
                case 73:
                case 75:
                    emoji = "üå®Ô∏è";
                    description = "NEIGE";
                    break;
                case 80:
                case 81:
                case 82:
                    emoji = "üå¶Ô∏è";
                    description = "AVERSES";
                    break;
                case 95:
                case 96:
                case 99:
                    emoji = "‚õàÔ∏è";
                    description = "ORAGE";
                    break;
                default:
                    // Fallback bas√© sur d'autres param√®tres
                    if (precipitation > 0.5) {
                        emoji = "üåßÔ∏è";
                        description = "PLUVIEUX";
                    } else if (cloudCover > 70) {
                        emoji = "‚òÅÔ∏è";
                        description = "TRES NUAGEUX";
                    } else if (cloudCover > 30) {
                        emoji = "‚õÖ";
                        description = "PARTIELLEMENT NUAGEUX";
                    } else if (windSpeed > 30) {
                        emoji = "üí®";
                        description = "VENTEUX";
                    } else {
                        emoji = isDay ? "‚òÄÔ∏è" : "üåô";
                        description = isDay ? "CLAIR" : "NUIT CLAIRE";
                    }
            }

            return { emoji, description };
        }

        // Afficher les alertes m√©t√©o
        function displayAlerts(data) {
            const alerts = [];
            const current = data.current;
            const daily = data.daily;

            // Alerte gel
            if (daily.temperature_2m_min[0] <= 0) {
                alerts.push(`‚ö†Ô∏è GEL NOCTURNE: ${daily.temperature_2m_min[0].toFixed(1)}¬∞C - Prot√©ger plantes et pare-brise`);
            }

            // Alerte canicule
            if (daily.temperature_2m_max[0] >= 35) {
                alerts.push(`‚ö†Ô∏è FORTE CHALEUR: ${daily.temperature_2m_max[0].toFixed(1)}¬∞C - Hydratation importante`);
            }

            // Alerte temp√™te
            if (current.wind_gusts_10m > 70) {
                alerts.push(`‚ö†Ô∏è RAFALES VIOLENTES: ${Math.round(current.wind_gusts_10m)} km/h - √âviter d√©placements`);
            }

            // Alerte visibilit√©
            if (current.visibility && current.visibility < 200) {
                alerts.push(`‚ö†Ô∏è BROUILLARD DENSE: Visibilit√© ${current.visibility}m - Conduite dangereuse`);
            }

            // Alerte UV
            if (current.uv_index && current.uv_index > 7) {
                alerts.push(`‚ö†Ô∏è UV EXTREMES: Indice ${current.uv_index.toFixed(1)} - Protection maximale requise`);
            }

            const alertsSection = document.getElementById('alerts-section');
            const alertsGrid = document.getElementById('alerts-grid');

            if (alerts.length > 0) {
                alertsSection.style.display = 'block';
                alertsGrid.innerHTML = alerts.map(alert => `<div class="alert-item">${alert}</div>`).join('');
            } else {
                alertsSection.style.display = 'none';
            }
        }

        // Fonction pour d√©terminer les p√©riodes de la journ√©e
        function getHourlyPeriods(hourlyData) {
            const now = new Date();
            const currentHour = now.getHours();
            const periods = [];

            // D√©terminer les heures cibles selon l'heure actuelle
            const targetHours = [];

            // Ajouter "Maintenant"
            targetHours.push({
                hour: currentHour,
                label: "MAINTENANT",
                isCurrent: true
            });

            // D√©terminer les prochaines p√©riodes pertinentes
            if (currentHour < 12) {
                targetHours.push({ hour: 12, label: "MIDI" });
                targetHours.push({ hour: 15, label: "APRES-MIDI" });
                targetHours.push({ hour: 19, label: "SOIREE" });
                targetHours.push({ hour: 23, label: "NUIT" });
            } else if (currentHour < 15) {
                targetHours.push({ hour: 15, label: "APRES-MIDI" });
                targetHours.push({ hour: 19, label: "SOIREE" });
                targetHours.push({ hour: 23, label: "NUIT" });
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
            } else if (currentHour < 19) {
                targetHours.push({ hour: 19, label: "SOIREE" });
                targetHours.push({ hour: 23, label: "NUIT" });
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
                targetHours.push({ hour: 12, label: "DEMAIN MIDI", nextDay: true });
            } else if (currentHour < 23) {
                targetHours.push({ hour: 23, label: "NUIT" });
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
                targetHours.push({ hour: 12, label: "DEMAIN MIDI", nextDay: true });
                targetHours.push({ hour: 15, label: "DEMAIN APM", nextDay: true });
            } else {
                targetHours.push({ hour: 8, label: "DEMAIN MATIN", nextDay: true });
                targetHours.push({ hour: 12, label: "DEMAIN MIDI", nextDay: true });
                targetHours.push({ hour: 15, label: "DEMAIN APM", nextDay: true });
                targetHours.push({ hour: 19, label: "DEMAIN SOIR", nextDay: true });
            }

            // Limiter √† 5 p√©riodes maximum
            return targetHours.slice(0, 5);
        }

        // Fonction pour obtenir l'emoji m√©t√©o horaire
        function getHourlyWeatherEmoji(weatherCode, isDay) {
            const emojiIcons = {
                0: isDay ? "‚òÄÔ∏è" : "üåô",
                1: isDay ? "üå§Ô∏è" : "üåô",
                2: isDay ? "‚õÖ" : "‚òÅÔ∏è",
                3: "‚òÅÔ∏è",
                45: "üå´Ô∏è",
                48: "üå´Ô∏è",
                51: "üå¶Ô∏è",
                53: "üå¶Ô∏è",
                55: "üå¶Ô∏è",
                61: "üåßÔ∏è",
                63: "üåßÔ∏è",
                65: "üåßÔ∏è",
                71: "üå®Ô∏è",
                73: "üå®Ô∏è",
                75: "üå®Ô∏è",
                80: "üå¶Ô∏è",
                81: "üå¶Ô∏è",
                82: "üå¶Ô∏è",
                95: "‚õàÔ∏è",
                96: "‚õàÔ∏è",
                99: "‚õàÔ∏è"
            };
            return emojiIcons[weatherCode] || "‚ùì";
        }

        // Afficher les pr√©visions horaires
        function displayHourlyForecast(hourlyData) {
            if (!hourlyData || !hourlyData.time) return;

            const periods = getHourlyPeriods(hourlyData);
            const now = new Date();
            let hourlyHTML = "";

            periods.forEach(period => {
                // Calculer l'index dans les donn√©es horaires
                let targetDate = new Date();
                if (period.nextDay) {
                    targetDate.setDate(targetDate.getDate() + 1);
                }
                targetDate.setHours(period.hour, 0, 0, 0);

                // Trouver l'index correspondant dans les donn√©es
                const targetTimeString = targetDate.toISOString().slice(0, 13) + ":00";
                const dataIndex = hourlyData.time.findIndex(t => t === targetTimeString);

                if (dataIndex === -1) return;

                const temp = Math.round(hourlyData.temperature_2m[dataIndex]);
                const rainProb = hourlyData.precipitation_probability[dataIndex] || 0;
                const rainAmount = hourlyData.precipitation[dataIndex] || 0;
                const windSpeed = Math.round(hourlyData.wind_speed_10m[dataIndex]);
                const weatherCode = hourlyData.weather_code ? hourlyData.weather_code[dataIndex] : 0;
                const isDay = hourlyData.is_day ? hourlyData.is_day[dataIndex] === 1 : (period.hour >= 7 && period.hour <= 20);

                // Format de l'heure
                const timeStr = period.hour.toString().padStart(2, '0') + ':00';

                hourlyHTML += `
                    <div class="hourly-item ${period.isCurrent ? 'current' : ''}">
                        <div class="hourly-period">${period.label}</div>
                        <div class="hourly-time">${timeStr}</div>
                        <div class="hourly-icon">${getHourlyWeatherEmoji(weatherCode, isDay)}</div>
                        <div class="hourly-temp">${temp}¬∞</div>
                        ${rainProb > 0 ? `<div class="hourly-rain">‚òÇ ${rainProb}%</div>` : '<div class="hourly-rain">&nbsp;</div>'}
                        <div class="hourly-wind">üí® ${windSpeed} km/h</div>
                    </div>
                `;
            });

            document.getElementById('hourly-container').innerHTML = hourlyHTML;
        }

        // Afficher pr√©visions 7 jours (3 jours en mode simple, 7 en agriculteur)
        function displayWeeklyForecast(daily) {
            const days = currentMode === 'simplified' ? 3 : 7;
            const dayNames = ['DIM', 'LUN', 'MAR', 'MER', 'JEU', 'VEN', 'SAM'];
            const dayNamesFull = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

            // Fonction intelligente pour obtenir l'ic√¥ne m√©t√©o selon plusieurs crit√®res
            function getWeatherEmoji(weatherCode, rainProb, maxTemp) {
                // D'abord v√©rifier la pluie
                if (rainProb > 60) {
                    return "üåßÔ∏è"; // Forte probabilit√© de pluie
                } else if (rainProb > 30) {
                    return "üå¶Ô∏è"; // Probabilit√© mod√©r√©e de pluie
                }

                // Ensuite traiter selon le code m√©t√©o
                // Mais ajuster pour le code 3 (couvert) si conditions agr√©ables
                if (weatherCode === 3) {
                    // Si couvert mais peu de pluie et temp√©rature douce
                    if (rainProb < 10 && maxTemp >= 15) {
                        return "‚õÖ"; // Partiellement nuageux au lieu de totalement couvert
                    }
                    // Sinon garder nuageux
                    return "‚òÅÔ∏è";
                }

                // Pour les autres codes, utiliser le mapping standard
                const emojiIcons = {
                    0: "‚òÄÔ∏è",
                    1: "üå§Ô∏è",
                    2: "‚õÖ",
                    45: "üå´Ô∏è",
                    48: "üå´Ô∏è",
                    51: "üå¶Ô∏è",
                    53: "üå¶Ô∏è",
                    55: "üå¶Ô∏è",
                    61: "üåßÔ∏è",
                    63: "üåßÔ∏è",
                    65: "üåßÔ∏è",
                    71: "üå®Ô∏è",
                    73: "üå®Ô∏è",
                    75: "üå®Ô∏è",
                    80: "üå¶Ô∏è",
                    81: "üå¶Ô∏è",
                    82: "üå¶Ô∏è",
                    95: "‚õàÔ∏è",
                    96: "‚õàÔ∏è",
                    99: "‚õàÔ∏è"
                };
                return emojiIcons[weatherCode] || "‚ùì";
            }

            // Cr√©er le HTML pour les jours
            let forecastHTML = "";
            const bestDays = [];

            for (let i = 0; i < days; i++) {
                const date = new Date(daily.time[i]);
                const dayIndex = date.getDay();
                const weatherCode = daily.weather_code ? daily.weather_code[i] : 0;
                const maxTemp = Math.round(daily.temperature_2m_max[i]);
                const minTemp = Math.round(daily.temperature_2m_min[i]);
                const rainProb = daily.precipitation_probability_max ? daily.precipitation_probability_max[i] : 0;
                const rainAmount = daily.precipitation_sum ? daily.precipitation_sum[i].toFixed(1) : 0;

                // D√©terminer le nom du jour
                const dayName = i === 0 ? "AUJOURD'HUI" : dayNames[dayIndex];

                // Ajouter aux meilleurs jours si peu de pluie
                if (rainProb < 30) {
                    bestDays.push(i === 0 ? "Aujourd'hui" : dayNamesFull[dayIndex]);
                }

                // Cr√©er le HTML pour ce jour
                forecastHTML += `
                    <div class="forecast-day ${i === 0 ? 'today' : ''}">
                        <div class="forecast-day-name">${dayName}</div>
                        <div class="forecast-icon">${getWeatherEmoji(weatherCode, rainProb, maxTemp)}</div>
                        <div class="forecast-temps">
                            <span class="temp-max">${maxTemp}¬∞</span>
                            <span style="color: #888;">/</span>
                            <span class="temp-min">${minTemp}¬∞</span>
                        </div>
                        ${rainProb > 0 ? `<div class="forecast-rain">‚òÇ ${rainProb}%</div>` : '<div class="forecast-rain">&nbsp;</div>'}
                    </div>
                `;
            }

            // Ins√©rer le HTML
            document.getElementById('forecast-container').innerHTML = forecastHTML;

            // Cr√©er le r√©sum√©
            let summaryHTML = "";
            if (bestDays.length > 0) {
                summaryHTML = `‚úì MEILLEURS JOURS: ${bestDays.join(", ")}`;
            } else {
                summaryHTML = "‚ö† Semaine pluvieuse - Pr√©voir parapluie";
            }

            // Ajouter info sur la tendance g√©n√©rale
            const avgRainProb = daily.precipitation_probability_max.slice(0, days).reduce((a, b) => a + b, 0) / days;
            const avgMaxTemp = daily.temperature_2m_max.slice(0, days).reduce((a, b) => a + b, 0) / days;

            summaryHTML += ` | Temp moy: ${Math.round(avgMaxTemp)}¬∞ | Pluie moy: ${Math.round(avgRainProb)}%`;

            document.getElementById('forecast-summary').innerHTML = summaryHTML;
        }

        // Calculer les recommandations d'activit√©s
        function calculateActivities(data) {
            const current = data.current;
            const daily = data.daily;
            const temp = current.temperature_2m;
            const rain = current.precipitation;
            const wind = current.wind_speed_10m;
            const humidity = current.relative_humidity_2m;
            const uvIndex = current.uv_index || 0;

            // Logique am√©lior√©e pour la tenue √©cole
            let schoolOutfit = "";

            // Utiliser les donn√©es horaires pour calculer temp matin et max journ√©e scolaire
            const hourly = data.hourly;
            const now = new Date();
            const currentHour = now.getHours();

            // Trouver temp√©rature du matin (8h-9h) ou actuelle si apr√®s 9h
            let morningTemp = temp;
            if (hourly && hourly.time && hourly.temperature_2m) {
                const todayMorning = hourly.time.findIndex(time => {
                    const hour = new Date(time).getHours();
                    return hour === 8 || hour === 9;
                });
                if (todayMorning !== -1) {
                    morningTemp = hourly.temperature_2m[todayMorning];
                }
            }

            // Max temp√©rature pendant les heures scolaires (9h-17h)
            let schoolMaxTemp = daily.temperature_2m_max[0];
            if (hourly && hourly.time && hourly.temperature_2m) {
                const schoolHours = [];
                hourly.time.forEach((time, index) => {
                    const hour = new Date(time).getHours();
                    const day = new Date(time).getDate();
                    const today = now.getDate();
                    if (day === today && hour >= 9 && hour <= 17) {
                        schoolHours.push(hourly.temperature_2m[index]);
                    }
                });
                if (schoolHours.length > 0) {
                    schoolMaxTemp = Math.max(...schoolHours);
                }
            }

            // Nouvelle logique bas√©e sur matin ET apr√®s-midi
            const tempDiff = schoolMaxTemp - morningTemp;

            if (morningTemp < 5) {
                schoolOutfit = "MANTEAU + ECHARPE";
            } else if (morningTemp < 10 && schoolMaxTemp > 18) {
                schoolOutfit = "VESTE + T-SHIRT (enlever midi)";
            } else if (morningTemp < 10) {
                schoolOutfit = "VESTE CHAUDE";
            } else if (morningTemp >= 10 && morningTemp < 15 && schoolMaxTemp > 20) {
                schoolOutfit = "GILET LEGER (enlever midi)";
            } else if (morningTemp < 15) {
                schoolOutfit = "GILET/PULL LEGER";
            } else if (schoolMaxTemp > 25) {
                schoolOutfit = "T-SHIRT + CASQUETTE";
            } else {
                schoolOutfit = "T-SHIRT SUFFISANT";
            }

            // Ajouter info pluie si n√©cessaire
            if (rain > 0.5 || daily.precipitation_probability_max[0] > 50) {
                schoolOutfit += " + IMPER";
            }

            // Logique pour randonn√©e
            let hiking = "";
            const visibility = current.visibility || 10000;
            if (rain < 0.1 && wind < 20 && temp >= 10 && temp <= 25 && visibility > 5000 && uvIndex < 8) {
                hiking = "IDEAL";
            } else if (rain < 1 && wind < 30 && temp >= 5 && temp <= 30 && visibility > 2000) {
                hiking = "ACCEPTABLE";
            } else if (rain > 5 || wind > 40 || temp < 0 || temp > 35 || visibility < 1000) {
                hiking = "DANGEREUX";
            } else {
                hiking = "DIFFICILE";
            }

            // Logique pour bivouac (plus exigeant)
            let camping = "";
            const minNightTemp = daily.temperature_2m_min[0];
            const rainProb = daily.precipitation_probability_max[0] || 0;

            if (rain < 0.1 && wind < 15 && temp >= 15 && minNightTemp >= 8 && rainProb < 20) {
                camping = "PARFAIT";
            } else if (rain < 0.5 && wind < 25 && minNightTemp >= 5 && rainProb < 40) {
                camping = "PREVOIR CHAUD";
            } else if (minNightTemp < 0) {
                camping = "GEL - EQUIPEMENT HIVER";
            } else if (rain > 2 || wind > 35 || rainProb > 70) {
                camping = "REPORTER";
            } else {
                camping = "CONDITIONS DIFFICILES";
            }

            return {
                school: schoolOutfit,
                sport: rain < 0.1 && wind < 25 && uvIndex < 8 ? "PARFAIT" : rain < 1 ? "ACCEPTABLE" : "REPORTER",
                picnic: temp > 15 && rain < 0.1 && uvIndex < 6 ? "IDEAL" : temp > 10 ? "PREVOIR PULL" : "TROP FROID",
                garden: rain < 0.1 && wind < 20 && temp > 5 ? "IDEAL" : "ATTENDRE",
                bbq: rain < 0.1 && wind < 15 ? "GO" : "REPORTER",
                car: rain < 0.1 ? "GO" : "ATTENDRE 2J",
                watering: rain > 2 ? "INUTILE" : temp > 25 || humidity < 40 ? "URGENT" : "OPTIONNEL",
                drying: rain < 0.1 && wind > 10 && humidity < 60 ? "PARFAIT" : rain < 0.1 ? "LENT" : "IMPOSSIBLE",
                hiking: hiking,
                camping: camping
            };
        }

        // Calculer les donn√©es d'humidit√© et de confort
        function calculateHumidityData(data) {
            const current = data.current;
            const temp = current.temperature_2m;
            const humidity = current.relative_humidity_2m;
            const rain = current.precipitation;

            // Sensation d'humidit√©
            let comfort = "";
            if (humidity < 30) {
                comfort = "TRES SEC";
            } else if (humidity < 40) {
                comfort = "SEC";
            } else if (humidity < 60) {
                comfort = "IDEAL";
            } else if (humidity < 70) {
                comfort = "HUMIDE";
            } else {
                comfort = "TRES HUMIDE";
            }

            // S√©choir int√©rieur avec temps de s√©chage
            let indoorDrying = "";
            if (rain > 0.1 || humidity > 80) {
                indoorDrying = "LENT (12H+)";
            } else if (temp < 10) {
                indoorDrying = "NORMAL (6-8H)";
            } else {
                indoorDrying = "RAPIDE (3-4H)";
            }

            // A√©ration maison
            let ventilate = "";
            if (humidity > 70) {
                ventilate = "URGENT - DESHUMIDIFIER";
            } else if (temp > 20 || humidity > 60) {
                ventilate = "RECOMMANDE";
            } else if (temp < 10) {
                ventilate = "NON - TROP FROID";
            } else {
                ventilate = "OPTIONNEL";
            }

            // Point de ros√©e (approximation)
            const dewPoint = temp - ((100 - humidity) / 5);

            // Risque de brouillard
            let fogRisk = "";
            const tempDewDiff = temp - dewPoint;
            if (tempDewDiff < 2) {
                fogRisk = "ELEVE";
            } else if (tempDewDiff < 5) {
                fogRisk = "MOYEN";
            } else {
                fogRisk = "FAIBLE";
            }

            return {
                humidity: Math.round(humidity),
                comfort: comfort,
                indoorDrying: indoorDrying,
                ventilate: ventilate,
                dewPoint: Math.round(dewPoint * 10) / 10,
                fogRisk: fogRisk
            };
        }

        // Calculer les donn√©es agricoles
        function calculateFarmerData(data) {
            const current = data.current;
            const daily = data.daily;
            const hourly = data.hourly;

            const temp = current.temperature_2m;
            const humidity = current.relative_humidity_2m;
            const windSpeed = current.wind_speed_10m;
            const rain = current.precipitation;

            // Risque de gel
            const minTempToday = daily.temperature_2m_min[0];
            let frostRiskToday = "FAIBLE";
            let frostProtection = "AUCUNE";

            if (minTempToday <= -2) {
                frostRiskToday = "ELEVE";
                frostProtection = "PAILLAGE URGENT";
            } else if (minTempToday <= 0) {
                frostRiskToday = "MOYEN";
                frostProtection = "PROTEGER SENSIBLES";
            } else if (minTempToday <= 2) {
                frostRiskToday = "FAIBLE";
                frostProtection = "SURVEILLER";
            }

            // Temp√©ratures minimales des prochaines nuits
            const nextNights = [];
            for (let i = 1; i <= 3; i++) {
                if (daily.temperature_2m_min[i] !== undefined) {
                    nextNights.push(daily.temperature_2m_min[i]);
                }
            }
            const frostNextNights = nextNights.length > 0 ? Math.min(...nextNights).toFixed(1) + "¬∞C" : "--¬∞C";

            // Jours sans gel
            let frostFreeDays = 0;
            for (let i = 0; i < 7; i++) {
                if (daily.temperature_2m_min[i] > 0) {
                    frostFreeDays++;
                } else {
                    break;
                }
            }

            // Besoins en irrigation
            const recentRain = daily.precipitation_sum.slice(0, 7).reduce((a, b) => a + b, 0);
            const evaporation = temp > 15 ? 4 : temp > 10 ? 2 : 1; // mm/jour approximatif
            let irrigationNeeds = "MODERES";
            let waterStress = "FAIBLE";

            if (recentRain < 5 && temp > 20) {
                irrigationNeeds = "URGENTS";
                waterStress = "ELEVE";
            } else if (recentRain < 10 && temp > 15) {
                irrigationNeeds = "RECOMMANDES";
                waterStress = "MOYEN";
            } else if (recentRain > 20) {
                irrigationNeeds = "REDUIRE";
                waterStress = "FAIBLE";
            }

            // Conditions de pulv√©risation
            let sprayingConditions = "FAVORABLES";
            let treatmentWind = "OK";

            if (windSpeed > 15) {
                sprayingConditions = "DEFAVORABLES";
                treatmentWind = "VENT FORT - RISQUE DERIVE";
            } else if (windSpeed > 10) {
                sprayingConditions = "LIMITES";
                treatmentWind = "VENT MODERE";
            }

            // Pluie dans 24h
            let rain24h = 0;
            if (hourly && hourly.precipitation) {
                for (let i = 0; i < 24 && i < hourly.precipitation.length; i++) {
                    rain24h += hourly.precipitation[i] || 0;
                }
            }
            rain24h = rain24h.toFixed(1);

            // Fen√™tre de traitement (heures sans pluie)
            let treatmentWindow = 24;
            if (hourly && hourly.precipitation) {
                for (let i = 0; i < 24 && i < hourly.precipitation.length; i++) {
                    if ((hourly.precipitation[i] || 0) > 0.1) {
                        treatmentWindow = i;
                        break;
                    }
                }
            }

            // Risques maladies
            let mildewRisk = "FAIBLE";
            let powderyMildewRisk = "FAIBLE";
            let fungalConditions = "DEFAVORABLES";
            let pestActivity = "FAIBLE";

            // Conditions favorables au mildiou (humidit√© + temp√©rature)
            if (humidity > 80 && temp > 10 && temp < 25 && rain > 0.5) {
                mildewRisk = "ELEVE";
                fungalConditions = "FAVORABLES";
            } else if (humidity > 70 && temp > 15 && temp < 20) {
                mildewRisk = "MOYEN";
                fungalConditions = "MODERE";
            }

            // Conditions favorables √† l'o√Ødium (s√©cheresse + chaleur)
            if (humidity < 50 && temp > 25) {
                powderyMildewRisk = "ELEVE";
            } else if (humidity < 60 && temp > 20) {
                powderyMildewRisk = "MOYEN";
            }

            // Activit√© des parasites
            if (temp > 20 && humidity > 60) {
                pestActivity = "ELEVE";
            } else if (temp > 15 && humidity > 50) {
                pestActivity = "MOYEN";
            }

            // === CALCULS SAISONNIERS ===

            // Obtenir le mois actuel pour adapter les recommandations
            const currentMonth = new Date().getMonth(); // 0-11
            const season = getSeason(currentMonth);

            // Calendrier agricole adapt√© √† la saison
            let optimalSeeding = "HORS SAISON";
            let harvestWindow = daily.precipitation_probability_max.slice(0, 7).filter(p => p < 30).length;
            let soilWork = rain < 0.5 && windSpeed < 20 ? "OUI" : "NON";
            let dryingConditions = humidity < 70 && windSpeed > 5 ? "FAVORABLES" : "DIFFICILES";

            // Recommandations selon la saison
            if (season === 'printemps') {
                optimalSeeding = temp > 8 && temp < 18 && rain < 2 ? "FAVORABLE" : "ATTENDRE RECHAUFFEMENT";
                soilWork = (temp > 5 && rain < 1) ? "IDEAL" : "ATTENDRE";
            } else if (season === 'ete') {
                optimalSeeding = temp > 15 && temp < 25 && rain < 1 ? "SEMIS ETE POSSIBLE" : "TROP CHAUD/SEC";
                soilWork = (temp < 30 && humidity > 40) ? "OUI MAIS ARROSER" : "ATTENDRE FRAICHEUR";
                dryingConditions = (temp > 20 && windSpeed > 8) ? "EXCELLENTES" : dryingConditions;
            } else if (season === 'automne') {
                optimalSeeding = temp > 10 && temp < 20 && rain < 1 ? "DERNIERS SEMIS" : "HORS TEMPS";
                soilWork = (temp > 8 && rain < 2) ? "DERNIERS TRAVAUX" : "ATTENDRE";
            } else { // hiver
                optimalSeeding = "SAISON TERMINEE";
                soilWork = (temp > 3 && rain < 0.5) ? "TRAVAUX HIVER POSSIBLES" : "CONDITIONS DIFFICILES";
            }

            // Fonction pour d√©terminer la saison
            function getSeason(month) {
                if (month >= 2 && month <= 4) return 'printemps'; // mars-mai
                if (month >= 5 && month <= 7) return 'ete'; // juin-ao√ªt
                if (month >= 8 && month <= 10) return 'automne'; // septembre-novembre
                return 'hiver'; // d√©cembre-f√©vrier
            }

            // === CALCULS SP√âCIFIQUES P√âPINI√àRE ===

            // Protection jeunes plants (arbres 1-2 ans plus sensibles au gel)
            let youngTreeFrost = "FAIBLE";
            if (minTempToday <= -5) {
                youngTreeFrost = "ELEVE";
            } else if (minTempToday <= -2) {
                youngTreeFrost = "MOYEN";
            }

            // Protection hivernale adapt√©e √† la saison
            let winterProtection = "PAILLIS L√âGER";
            if (season === 'hiver') {
                if (minTempToday <= -10) {
                    winterProtection = "VOILE D'HIVERNAGE + PAILLIS EPAIS";
                } else if (minTempToday <= -5) {
                    winterProtection = "PAILLIS EPAIS + PROTECTION RACINES";
                } else if (minTempToday <= 0) {
                    winterProtection = "PAILLIS + SURVEILLANCE";
                }
            } else if (season === 'automne') {
                winterProtection = "PREPARATION HIVERNALE - PAILLIS";
            } else {
                winterProtection = "PROTECTION NON NECESSAIRE";
            }

            // Arrosage adapt√© √† la saison (pr√©vention dess√®chement)
            let winterWatering = "SELON BESOINS";
            if (season === 'hiver') {
                if (humidity < 40 && windSpeed > 10) {
                    winterWatering = "ARROSAGE ANTI-DESS√àCHEMENT";
                } else if (humidity < 60) {
                    winterWatering = "ARROSAGE MOD√âR√â";
                } else {
                    winterWatering = "ARROSAGE R√âDUIT";
                }
            } else if (season === 'automne') {
                winterWatering = "DERNIERS ARROSAGES PROFONDS";
            } else if (season === 'printemps') {
                winterWatering = "REPRISE ARROSAGE PROGRESSIVE";
            } else {
                winterWatering = "ARROSAGE REGULIER";
            }

            // Taille adapt√©e √† la saison
            let winterPruning = "SELON ESP√àCE";
            if (season === 'hiver') {
                if (minTempToday < -5) {
                    winterPruning = "ATTENDRE R√âCHAUFFEMENT (+5¬∞C)";
                } else if (rain > 2) {
                    winterPruning = "ATTENDRE TEMPS SEC";
                } else {
                    winterPruning = "TAILLE HIVERNALE POSSIBLE";
                }
            } else if (season === 'printemps') {
                winterPruning = "TAILLE DE FLORAISON";
            } else if (season === 'ete') {
                winterPruning = "TAILLE VERTE POSSIBLE";
            } else {
                winterPruning = "TAILLE D'AUTOMNE";
            }

            // Maladies sp√©cifiques fruitiers
            let scabRisk = "FAIBLE"; // Tavelure
            let moniliniaRisk = "FAIBLE"; // Moniliose
            let fruitPowderyMildew = "FAIBLE"; // O√Ødium fruitiers
            let preventiveTreatment = "NON";

            // Tavelure (humidit√© + temp√©rature douce)
            if (humidity > 70 && temp > 5 && temp < 15 && rain > 1) {
                scabRisk = "ELEVE";
                preventiveTreatment = "OUI - CUIVRE";
            } else if (humidity > 60 && temp > 8 && temp < 18) {
                scabRisk = "MOYEN";
            }

            // Moniliose (humidit√© + fleurs)
            if (humidity > 80 && temp > 10 && temp < 20 && rain > 0.5) {
                moniliniaRisk = "ELEVE";
            } else if (humidity > 70 && temp > 12 && temp < 18) {
                moniliniaRisk = "MOYEN";
            }

            // O√Ødium fruitiers (s√©cheresse + chaleur)
            if (humidity < 50 && temp > 20) {
                fruitPowderyMildew = "ELEVE";
            } else if (humidity < 60 && temp > 18) {
                fruitPowderyMildew = "MOYEN";
            }

            // Conditions de floraison
            let floweringConditions = "FAVORABLES";
            if (windSpeed > 20) {
                floweringConditions = "VENTEUSES";
            } else if (rain > 5) {
                floweringConditions = "PLUVIEUSES";
            }

            // Risque gel floraison (printemps)
            let floweringFrostRisk = "AUCUN";
            if (currentMonth >= 2 && currentMonth <= 4) { // Mars √† mai
                if (minTempToday <= -2) {
                    floweringFrostRisk = "ELEVE";
                } else if (minTempToday <= 0) {
                    floweringFrostRisk = "MOYEN";
                }
            }

            // Activit√© des abeilles
            let beeActivity = "MODEREE";
            if (temp < 10) {
                beeActivity = "FAIBLE";
            } else if (temp > 18 && windSpeed < 15) {
                beeActivity = "ELEVE";
            } else if (temp > 25 || windSpeed > 20) {
                beeActivity = "REDUITE";
            }

            // Fen√™tre pollinisation
            let pollinationWindow = 0;
            if (temp > 12 && temp < 25 && windSpeed < 20) {
                pollinationWindow = daily.temperature_2m_max.slice(0, 7).filter(t => t > 15 && t < 25).length;
            }

            // Calendrier p√©pini√®re adapt√© aux saisons
            let springPlanting = "HORS SAISON";
            let summerPruning = "HORS SAISON";
            let fruitHarvest = "SELON VARI√âT√âS";
            let winterPrep = "SELON SAISON";

            if (season === 'printemps') {
                springPlanting = temp > 8 && temp < 18 && rain < 2 ? "CONDITIONS OPTIMALES" : "ATTENDRE R√âCHAUFFEMENT";
                fruitHarvest = harvestWindow > 3 ? "D√âBUT R√âCOLTE" : "PLUS TARD";
            } else if (season === 'ete') {
                summerPruning = temp > 15 && humidity < 80 && windSpeed < 15 ? "TAILLE VERTE POSSIBLE" : "ATTENDRE FRA√éCHEUR";
                fruitHarvest = harvestWindow > 3 ? "PLEINE R√âCOLTE" : "SURVEILLER";
            } else if (season === 'automne') {
                fruitHarvest = harvestWindow > 3 ? "FIN R√âCOLTE" : "R√âCOLTE TERMIN√âE";
                winterPrep = minTempToday < 8 ? "PR√âPARATION URGENTE" : "EN COURS";
            } else { // hiver
                winterPrep = minTempToday < 0 ? "PROTECTIONS MAXIMALES" : "MAINTIEN HIVERNAL";
            }

            return {
                // Donn√©es agricoles existantes
                frostRiskToday,
                frostNextNights,
                frostProtection,
                frostFreeDays,
                irrigationNeeds,
                recentRain: recentRain.toFixed(1),
                evaporation,
                waterStress,
                sprayingConditions,
                treatmentWind,
                rain24h,
                treatmentWindow,
                mildewRisk,
                powderyMildewRisk,
                fungalConditions,
                pestActivity,
                optimalSeeding,
                harvestWindow,
                soilWork,
                dryingConditions,
                // Nouvelles donn√©es p√©pini√®re
                youngTreeFrost,
                winterProtection,
                winterWatering,
                winterPruning,
                scabRisk,
                moniliniaRisk,
                fruitPowderyMildew,
                preventiveTreatment,
                floweringConditions,
                floweringFrostRisk,
                beeActivity,
                pollinationWindow,
                springPlanting,
                summerPruning,
                fruitHarvest,
                winterPrep
            };
        }

        // Afficher les alertes agricoles
        function displayFarmerAlerts(data) {
            const alerts = [];
            const daily = data.daily;
            const current = data.current;

            // Alerte gel s√©v√®re
            if (daily.temperature_2m_min[0] <= -2) {
                alerts.push(`‚ùÑÔ∏è GEL SEVERE: ${daily.temperature_2m_min[0].toFixed(1)}¬∞C - Protection maximale requise`);
            }

            // Alerte s√©cheresse
            const weeklyRain = daily.precipitation_sum.slice(0, 7).reduce((a, b) => a + b, 0);
            if (weeklyRain < 5) {
                alerts.push(`üåµ SECHERESSE: ${weeklyRain.toFixed(1)}mm/semaine - Irrigation urgente`);
            }

            // Alerte maladies
            if (current.relative_humidity_2m > 80 && current.temperature_2m > 10 && current.temperature_2m < 25) {
                alerts.push(`üçÑ RISQUE MALADIES: Conditions favorables au mildiou - Traiter pr√©ventivement`);
            }

            // Alerte vent fort pour traitements
            if (current.wind_speed_10m > 15) {
                alerts.push(`üí® VENT FORT: ${Math.round(current.wind_speed_10m)}km/h - Reporter les pulv√©risations`);
            }

            const alertsSection = document.getElementById('farmer-alerts');
            const alertsGrid = document.getElementById('farmer-alerts-grid');

            if (alerts.length > 0) {
                alertsSection.style.display = 'block';
                alertsGrid.innerHTML = alerts.map(alert => `<div class="alert-item">${alert}</div>`).join('');
            } else {
                alertsSection.style.display = 'none';
            }
        }

        // Autocompl√©tion des villes
        let searchTimeout;
        let selectedSuggestionIndex = -1;
        let suggestions = [];

        async function searchCities(query) {
            if (query.length < 2) return [];

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=8&countrycodes=fr,be,ch,lu,es,it,de,gb`
                );
                const results = await response.json();

                return results
                    .filter(result => result.type === 'administrative' || result.type === 'city' || result.class === 'place')
                    .map(result => ({
                        name: result.display_name.split(',')[0],
                        fullName: result.display_name,
                        lat: parseFloat(result.lat),
                        lon: parseFloat(result.lon),
                        country: result.display_name.split(',').pop().trim()
                    }))
                    .slice(0, 5);
            } catch (error) {
                console.error('Erreur recherche villes:', error);
                return [];
            }
        }

        function displaySuggestions(cityResults) {
            const suggestionsContainer = document.getElementById('city-suggestions');

            if (cityResults.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            suggestions = cityResults;
            selectedSuggestionIndex = -1;

            suggestionsContainer.innerHTML = cityResults
                .map((city, index) =>
                    `<div class="city-suggestion" data-index="${index}">
                        ${city.name}, ${city.country}
                    </div>`
                ).join('');

            suggestionsContainer.style.display = 'block';

            // Gestion des clics sur les suggestions
            suggestionsContainer.querySelectorAll('.city-suggestion').forEach((element, index) => {
                element.addEventListener('click', () => selectCity(suggestions[index]));
            });
        }

        function selectCity(city) {
            currentCity = {
                name: city.name.toUpperCase(),
                lat: city.lat,
                lon: city.lon
            };

            // Mettre √† jour l'interface
            document.getElementById('city-input').value = '';
            document.getElementById('city-suggestions').style.display = 'none';

            // Mettre √† jour l'affichage de la ville sous le titre
            document.getElementById('city-display').textContent = `Ville: ${currentCity.name}`;

            // Mettre √† jour le footer avec la nouvelle ville
            document.getElementById('footer-city').textContent = currentCity.name;
            document.getElementById('footer-coords').textContent = `${currentCity.lat.toFixed(1)}¬∞N, ${currentCity.lon.toFixed(1)}¬∞E`;

            // Sauvegarder la pr√©f√©rence
            localStorage.setItem('preferred_city', JSON.stringify(currentCity));

            // Recharger les donn√©es m√©t√©o
            loadWeatherData(true);
        }

        // D√©finir un mode sp√©cifique
        function setMode(mode) {
            const body = document.body;

            // Retirer toutes les classes de mode
            body.classList.remove('simplified-mode', 'farmer-mode');

            // Mettre √† jour le mode actuel
            currentMode = mode;

            // Appliquer la classe appropri√©e
            if (mode === 'simplified') {
                body.classList.add('simplified-mode');
            } else if (mode === 'farmer') {
                body.classList.add('farmer-mode');
            }

            // Sauvegarder en localStorage
            localStorage.setItem('meteo_mode', mode);

            // Mettre √† jour l'apparence des boutons
            updateModeButtons();

            // Recharger l'affichage avec le nouveau mode
            if (window.lastWeatherData) {
                displayWeatherData(window.lastWeatherData);
            }
        }

        // Mettre √† jour l'apparence des boutons de mode
        function updateModeButtons() {
            const buttons = ['advanced', 'simplified', 'farmer'];
            buttons.forEach(mode => {
                const button = document.getElementById(`mode-${mode}`);
                if (currentMode === mode) {
                    button.style.background = 'rgba(0, 255, 0, 0.2)';
                    button.style.borderColor = '#ffff00';
                } else {
                    button.style.background = 'transparent';
                    button.style.borderColor = '#00ff00';
                }
            });
        }

        // Syst√®me de cache pour limiter les appels API
        function getCachedData() {
            try {
                const cached = localStorage.getItem(getCacheKey());
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    const now = Date.now();
                    // V√©rifier si le cache est encore valide
                    if (now - timestamp < CACHE_DURATION) {
                        console.log('Utilisation du cache (valide pendant', Math.round((CACHE_DURATION - (now - timestamp)) / 1000), 'secondes)');
                        return data;
                    } else {
                        console.log('Cache expir√©, nouvelle requ√™te API');
                    }
                }
            } catch (error) {
                console.error('Erreur lecture cache:', error);
            }
            return null;
        }

        function setCachedData(data) {
            try {
                const cacheObject = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(getCacheKey(), JSON.stringify(cacheObject));
                console.log('Donn√©es mises en cache pour', currentCity.name);
            } catch (error) {
                console.error('Erreur √©criture cache:', error);
            }
        }

        async function loadWeatherData(forceRefresh = false) {
            try {
                let data = null;

                // Essayer de r√©cup√©rer depuis le cache sauf si forceRefresh est activ√©
                if (!forceRefresh) {
                    data = getCachedData();
                }

                // Si pas de donn√©es en cache ou forceRefresh, faire un appel API
                if (!data) {
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/forecast?latitude=${currentCity.lat}&longitude=${currentCity.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,cloud_cover,pressure_msl,wind_speed_10m,wind_direction_10m,wind_gusts_10m,uv_index,visibility&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,sunrise,sunset,uv_index_max,weather_code&hourly=temperature_2m,precipitation_probability,precipitation,wind_speed_10m,weather_code,is_day&timezone=Europe%2FParis&forecast_days=7`
                    );

                    if (!response.ok) {
                        throw new Error('Erreur chargement donn√©es');
                    }

                    data = await response.json();
                    // Mettre en cache les nouvelles donn√©es
                    setCachedData(data);
                }

                displayWeatherData(data);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('weather-content').style.display = 'block';

                // Afficher l'heure de derni√®re mise √† jour depuis les donn√©es
                const cacheInfo = getCachedData() ? ' (depuis cache)' : ' (nouvelles donn√©es)';
                document.getElementById('timestamp').textContent =
                    `DERNIERE MAJ: ${new Date().toLocaleString('fr-FR')}${cacheInfo}`;

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').innerHTML =
                    '<span style="color: #ff0000;">ERREUR CONNEXION SATELLITE - RETRY...</span>';
            }
        }

        function displayWeatherData(data) {
            const current = data.current;
            const daily = data.daily;

            // Sauvegarder les donn√©es pour le toggle de mode
            window.lastWeatherData = data;

            // Temp√©rature
            document.getElementById('temp-current').textContent = `${Math.round(current.temperature_2m)}¬∞C`;
            document.getElementById('temp-feels').textContent = `${Math.round(current.apparent_temperature)}¬∞C`;
            document.getElementById('temp-minmax').textContent = `${Math.round(daily.temperature_2m_min[0])}¬∞C / ${Math.round(daily.temperature_2m_max[0])}¬∞C`;

            // R√©sum√© simplifi√©
            document.getElementById('simple-temp').textContent = `${Math.round(current.temperature_2m)}¬∞C`;

            // Pr√©cipitations
            const rainProb = daily.precipitation_probability_max[0] || 0;
            document.getElementById('rain-prob').textContent = `${rainProb}%`;
            document.getElementById('rain-amount').textContent = current.precipitation > 0 ? `${current.precipitation.toFixed(1)} mm` : "< 0.1 mm";
            document.getElementById('umbrella-needed').textContent = rainProb > 70 ? "OUI" : "NON";

            // R√©sum√© simplifi√© - pr√©cipitations
            document.getElementById('simple-rain').textContent = `${rainProb}%`;

            // Vent
            document.getElementById('wind-speed').textContent = `${Math.round(current.wind_speed_10m)} km/h`;
            document.getElementById('wind-gusts').textContent = `${Math.round(current.wind_gusts_10m)} km/h`;
            document.getElementById('wind-direction').textContent = getWindDirection(current.wind_direction_10m);
            document.getElementById('wind-class').textContent = getWindClassification(current.wind_speed_10m);
            document.getElementById('wind-danger').textContent = current.wind_speed_10m > 50 ? "OUI" : "NON";

            // R√©sum√© simplifi√© - vent
            document.getElementById('simple-wind').textContent = `${Math.round(current.wind_speed_10m)} km/h`;

            // Visibilit√© et phares
            const visibility = current.visibility || 10000;
            const visibilityKm = (visibility / 1000).toFixed(1);
            document.getElementById('visibility').textContent = visibility > 1000 ? `${visibilityKm} km` : `${visibility} m`;
            document.getElementById('headlights').textContent = visibility < 1000 ? "OUI" : "NON";
            if (visibility < 1000) {
                document.getElementById('headlights').className = 'value warning';
            }

            // R√©sum√© simplifi√© - visibilit√©
            document.getElementById('simple-visibility').textContent = visibility > 1000 ? `${visibilityKm} km` : `${visibility}m`;

            // Indice UV
            const uvIndex = current.uv_index || 0;
            const uvMax = daily.uv_index_max ? daily.uv_index_max[0] : 0;
            document.getElementById('uv-index').textContent = `${uvIndex.toFixed(1)} (max: ${uvMax.toFixed(1)})`;
            document.getElementById('sunscreen').textContent = uvIndex > 2 ? "OUI" : "NON";
            if (uvIndex > 2) {
                document.getElementById('sunscreen').className = 'value warning';
            }

            // Heures soleil
            if (daily.sunrise && daily.sunset) {
                const sunrise = new Date(daily.sunrise[0]);
                const sunset = new Date(daily.sunset[0]);
                const now = new Date();

                document.getElementById('sunrise').textContent = sunrise.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('sunset').textContent = sunset.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                if (now < sunset && now > sunrise) {
                    const remaining = (sunset - now) / (1000 * 60 * 60);
                    const hours = Math.floor(remaining);
                    const minutes = Math.floor((remaining - hours) * 60);
                    document.getElementById('daylight-remaining').textContent = `${hours}h${minutes < 10 ? '0' : ''}${minutes}`;
                } else {
                    document.getElementById('daylight-remaining').textContent = "NUIT";
                }
            }

            // ASCII Art et description m√©t√©o
            const visualization = getWeatherVisualization(
                current.weather_code,
                current.is_day === 1,
                current.precipitation,
                current.cloud_cover,
                current.wind_speed_10m
            );
            document.getElementById('weather-icon').textContent = visualization.emoji;
            document.getElementById('weather-description').textContent = visualization.description;

            // Alertes m√©t√©o
            displayAlerts(data);

            // Pr√©visions horaires
            if (data.hourly) {
                displayHourlyForecast(data.hourly);
            }

            // Graphique pr√©visions 7 jours
            if (data.daily) {
                displayWeeklyForecast(data.daily);
            }

            // Donn√©es d'humidit√© et de confort
            const humidityData = calculateHumidityData(data);
            document.getElementById('humidity-current').textContent = `${humidityData.humidity}%`;
            document.getElementById('humidity-comfort').textContent = humidityData.comfort;
            document.getElementById('humidity-indoor-drying').textContent = humidityData.indoorDrying;
            document.getElementById('humidity-ventilate').textContent = humidityData.ventilate;
            document.getElementById('dew-point').textContent = `${humidityData.dewPoint}¬∞C`;
            document.getElementById('fog-risk').textContent = humidityData.fogRisk;

            // Activit√©s et conseils
            const activities = calculateActivities(data);
            document.getElementById('activity-school').textContent = activities.school;
            document.getElementById('activity-sport').textContent = activities.sport;
            document.getElementById('activity-picnic').textContent = activities.picnic;
            document.getElementById('activity-garden').textContent = activities.garden;
            document.getElementById('activity-bbq').textContent = activities.bbq;
            document.getElementById('activity-car').textContent = activities.car;
            document.getElementById('activity-watering').textContent = activities.watering;
            document.getElementById('activity-drying').textContent = activities.drying;
            document.getElementById('activity-hiking').textContent = activities.hiking;
            document.getElementById('activity-camping').textContent = activities.camping;

            // Donn√©es agricoles si mode agriculteur
            if (currentMode === 'farmer') {
                const farmerData = calculateFarmerData(data);
                displayFarmerAlerts(data);

                // Gel et protection
                document.getElementById('frost-risk-today').textContent = farmerData.frostRiskToday;
                document.getElementById('frost-next-nights').textContent = farmerData.frostNextNights;
                document.getElementById('frost-protection').textContent = farmerData.frostProtection;
                document.getElementById('frost-free-days').textContent = farmerData.frostFreeDays;

                // Irrigation
                document.getElementById('irrigation-needs').textContent = farmerData.irrigationNeeds;
                document.getElementById('recent-rain').textContent = farmerData.recentRain + " mm";
                document.getElementById('evaporation').textContent = farmerData.evaporation + " mm/jour";
                document.getElementById('water-stress').textContent = farmerData.waterStress;

                // Traitements
                document.getElementById('spraying-conditions').textContent = farmerData.sprayingConditions;
                document.getElementById('treatment-wind').textContent = farmerData.treatmentWind;
                document.getElementById('rain-24h').textContent = farmerData.rain24h + " mm";
                document.getElementById('treatment-window').textContent = farmerData.treatmentWindow + "h";

                // Maladies
                document.getElementById('mildew-risk').textContent = farmerData.mildewRisk;
                document.getElementById('powdery-mildew-risk').textContent = farmerData.powderyMildewRisk;
                document.getElementById('fungal-conditions').textContent = farmerData.fungalConditions;
                document.getElementById('pest-activity').textContent = farmerData.pestActivity;

                // Calendrier
                document.getElementById('optimal-seeding').textContent = farmerData.optimalSeeding;
                document.getElementById('harvest-window').textContent = farmerData.harvestWindow + " jours";
                document.getElementById('soil-work').textContent = farmerData.soilWork;
                document.getElementById('drying-conditions').textContent = farmerData.dryingConditions;

                // === DONN√âES P√âPINI√àRE ===

                // Protection jeunes plants
                document.getElementById('young-tree-frost').textContent = farmerData.youngTreeFrost;
                document.getElementById('winter-protection').textContent = farmerData.winterProtection;
                document.getElementById('winter-watering').textContent = farmerData.winterWatering;
                document.getElementById('winter-pruning').textContent = farmerData.winterPruning;

                // Maladies fruitiers
                document.getElementById('scab-risk').textContent = farmerData.scabRisk;
                document.getElementById('monilinia-risk').textContent = farmerData.moniliniaRisk;
                document.getElementById('fruit-powdery-mildew').textContent = farmerData.fruitPowderyMildew;
                document.getElementById('preventive-treatment').textContent = farmerData.preventiveTreatment;

                // Floraison et pollinisation
                document.getElementById('flowering-conditions').textContent = farmerData.floweringConditions;
                document.getElementById('flowering-frost-risk').textContent = farmerData.floweringFrostRisk;
                document.getElementById('bee-activity').textContent = farmerData.beeActivity;
                document.getElementById('pollination-window').textContent = farmerData.pollinationWindow + " jours";

                // Calendrier p√©pini√®re
                document.getElementById('spring-planting').textContent = farmerData.springPlanting;
                document.getElementById('summer-pruning').textContent = farmerData.summerPruning;
                document.getElementById('fruit-harvest').textContent = farmerData.fruitHarvest;
                document.getElementById('winter-prep').textContent = farmerData.winterPrep;

                // Colorer selon les niveaux de risque
                const frostElement = document.getElementById('frost-risk-today');
                if (farmerData.frostRiskToday === 'ELEVE') {
                    frostElement.className = 'value status-frost-high';
                } else if (farmerData.frostRiskToday === 'MOYEN') {
                    frostElement.className = 'value status-frost-medium';
                } else {
                    frostElement.className = 'value status-frost-low';
                }

                const waterElement = document.getElementById('water-stress');
                if (farmerData.waterStress === 'ELEVE') {
                    waterElement.className = 'value status-water-high';
                } else if (farmerData.waterStress === 'MOYEN') {
                    waterElement.className = 'value status-water-medium';
                } else {
                    waterElement.className = 'value status-water-low';
                }

                const mildewElement = document.getElementById('mildew-risk');
                if (farmerData.mildewRisk === 'ELEVE') {
                    mildewElement.className = 'value status-disease-high';
                } else if (farmerData.mildewRisk === 'MOYEN') {
                    mildewElement.className = 'value status-disease-medium';
                } else {
                    mildewElement.className = 'value status-disease-low';
                }

                const oidumElement = document.getElementById('powdery-mildew-risk');
                if (farmerData.powderyMildewRisk === 'ELEVE') {
                    oidumElement.className = 'value status-disease-high';
                } else if (farmerData.powderyMildewRisk === 'MOYEN') {
                    oidumElement.className = 'value status-disease-medium';
                } else {
                    oidumElement.className = 'value status-disease-low';
                }

                // Colorer les √©l√©ments p√©pini√®re
                const youngFrostElement = document.getElementById('young-tree-frost');
                if (farmerData.youngTreeFrost === 'ELEVE') {
                    youngFrostElement.className = 'value status-young-frost-high';
                } else if (farmerData.youngTreeFrost === 'MOYEN') {
                    youngFrostElement.className = 'value status-young-frost-medium';
                } else {
                    youngFrostElement.className = 'value status-young-frost-low';
                }

                const scabElement = document.getElementById('scab-risk');
                if (farmerData.scabRisk === 'ELEVE') {
                    scabElement.className = 'value status-fruit-disease-high';
                } else if (farmerData.scabRisk === 'MOYEN') {
                    scabElement.className = 'value status-fruit-disease-medium';
                } else {
                    scabElement.className = 'value status-fruit-disease-low';
                }

                const moniliniaElement = document.getElementById('monilinia-risk');
                if (farmerData.moniliniaRisk === 'ELEVE') {
                    moniliniaElement.className = 'value status-fruit-disease-high';
                } else if (farmerData.moniliniaRisk === 'MOYEN') {
                    moniliniaElement.className = 'value status-fruit-disease-medium';
                } else {
                    moniliniaElement.className = 'value status-fruit-disease-low';
                }

                const fruitPowderyElement = document.getElementById('fruit-powdery-mildew');
                if (farmerData.fruitPowderyMildew === 'ELEVE') {
                    fruitPowderyElement.className = 'value status-fruit-disease-high';
                } else if (farmerData.fruitPowderyMildew === 'MOYEN') {
                    fruitPowderyElement.className = 'value status-fruit-disease-medium';
                } else {
                    fruitPowderyElement.className = 'value status-fruit-disease-low';
                }

                const floweringElement = document.getElementById('flowering-conditions');
                if (farmerData.floweringConditions === 'FAVORABLES') {
                    floweringElement.className = 'value status-flowering-good';
                } else {
                    floweringElement.className = 'value status-flowering-caution';
                }

                const floweringFrostElement = document.getElementById('flowering-frost-risk');
                if (farmerData.floweringFrostRisk === 'ELEVE') {
                    floweringFrostElement.className = 'value status-flowering-bad';
                } else if (farmerData.floweringFrostRisk === 'MOYEN') {
                    floweringFrostElement.className = 'value status-flowering-caution';
                } else {
                    floweringFrostElement.className = 'value status-flowering-good';
                }
            }

            // Colorer les √©l√©ments d'humidit√©
            const humidityElements = [
                { id: 'humidity-comfort', value: humidityData.comfort },
                { id: 'humidity-indoor-drying', value: humidityData.indoorDrying },
                { id: 'humidity-ventilate', value: humidityData.ventilate },
                { id: 'fog-risk', value: humidityData.fogRisk }
            ];

            humidityElements.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    if (item.value.includes('IDEAL') || item.value.includes('RAPIDE') || item.value.includes('FAIBLE') ||
                        item.value.includes('OPTIONNEL')) {
                        element.className = 'value status-ok';
                    } else if (item.value.includes('SEC') || item.value.includes('HUMIDE') || item.value.includes('NORMAL') ||
                               item.value.includes('RECOMMANDE') || item.value.includes('MOYEN')) {
                        element.className = 'value status-caution';
                    } else if (item.value.includes('TRES') || item.value.includes('LENT') || item.value.includes('URGENT') ||
                               item.value.includes('ELEVE') || item.value.includes('NON')) {
                        element.className = 'value status-bad';
                    } else {
                        element.className = 'value';
                    }
                }
            });

            // Colorer selon les r√©sultats des activit√©s
            ['school', 'sport', 'picnic', 'garden', 'bbq', 'car', 'watering', 'drying', 'hiking', 'camping'].forEach(activity => {
                const element = document.getElementById(`activity-${activity}`);
                if (element) {
                    const text = element.textContent;
                    if (text.includes('PARFAIT') || text.includes('IDEAL') || text.includes('GO') ||
                        text.includes('T-SHIRT') || text.includes('INUTILE')) {
                        element.className = 'status-ok';
                    } else if (text.includes('PREVOIR') || text.includes('ATTENDRE') || text.includes('DIFFICILE') ||
                               text.includes('OPTIONNEL') || text.includes('GILET') || text.includes('VESTE') ||
                               text.includes('ACCEPTABLE') || text.includes('CONDITIONS')) {
                        element.className = 'status-caution';
                    } else if (text.includes('MANTEAU') || text.includes('REPORTER') || text.includes('DANGEREUX') ||
                               text.includes('IMPOSSIBLE') || text.includes('URGENT') || text.includes('GEL')) {
                        element.className = 'status-bad';
                    }
                }
            });
        }


        // Gestion des √©v√©nements du champ de recherche
        document.addEventListener('DOMContentLoaded', () => {
            const cityInput = document.getElementById('city-input');
            const suggestionsContainer = document.getElementById('city-suggestions');

            // Charger la ville pr√©f√©r√©e au d√©marrage
            const preferredCity = localStorage.getItem('preferred_city');
            if (preferredCity) {
                currentCity = JSON.parse(preferredCity);
                document.getElementById('city-display').textContent = `Ville: ${currentCity.name}`;
                document.getElementById('footer-city').textContent = currentCity.name;
                document.getElementById('footer-coords').textContent = `${currentCity.lat.toFixed(1)}¬∞N, ${currentCity.lon.toFixed(1)}¬∞E`;
            }

            // √âv√©nements du champ de saisie
            cityInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim();

                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    if (query.length >= 2) {
                        const cities = await searchCities(query);
                        displaySuggestions(cities);
                    } else {
                        suggestionsContainer.style.display = 'none';
                    }
                }, 300);
            });

            // Navigation au clavier
            cityInput.addEventListener('keydown', (e) => {
                if (suggestions.length === 0) return;

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                        updateSelectedSuggestion();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                        updateSelectedSuggestion();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0) {
                            selectCity(suggestions[selectedSuggestionIndex]);
                        }
                        break;
                    case 'Escape':
                        suggestionsContainer.style.display = 'none';
                        cityInput.blur();
                        break;
                }
            });

            // Fermer les suggestions en cliquant ailleurs
            document.addEventListener('click', (e) => {
                if (!cityInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });

            function updateSelectedSuggestion() {
                const suggestionElements = suggestionsContainer.querySelectorAll('.city-suggestion');
                suggestionElements.forEach((el, index) => {
                    el.classList.toggle('selected', index === selectedSuggestionIndex);
                });
            }

            // Mettre √† jour le footer avec les coordonn√©es actuelles
            function updateFooter() {
                document.getElementById('footer-city').textContent = currentCity.name;
                document.getElementById('footer-coords').textContent = `${currentCity.lat.toFixed(1)}¬∞N, ${currentCity.lon.toFixed(1)}¬∞E`;
            }

            // Charger le mode pr√©f√©r√©
            const savedMode = localStorage.getItem('meteo_mode') || 'advanced';
            setMode(savedMode);

            // Charger les donn√©es au d√©marrage
            loadWeatherData();
            updateFooter();

            // Actualiser toutes les 10 minutes (force le rafra√Æchissement depuis l'API)
            setInterval(() => loadWeatherData(true), 600000);
        });
    </script>
</body>
</html>